
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Python Boilerplate contains all the boilerplate you need to create a Python package.">
      
      
        <meta name="author" content="olakiril, alexevag">
      
      
        <link rel="canonical" href="https://ef-lab.github.io/ethopy_package/API/experiment/">
      
      
        <link rel="prev" href="../behavior/">
      
      
        <link rel="next" href="../interface/">
      
      
      <link rel="icon" href="../../assets/EthoPy_logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.10">
    
    
      
        <title>Experiment Module - EthoPy</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CRegular:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Google Sans";--md-code-font:"Regular"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#core-experiment-module" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="EthoPy" class="md-header__button md-logo" aria-label="EthoPy" data-md-component="logo">
      
  <img src="../../assets/EthoPy_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EthoPy
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Experiment Module
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ef-lab/ethopy_package" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
  Overview

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../getting_started/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../logger/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/" class="md-tabs__link">
        
  
  
    
  
  Contributing

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="https://github.com/ef-lab/ethopy_package/issues" class="md-tabs__link">
        
  
  
    
  
  Report Issues

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="EthoPy" class="md-nav__button md-logo" aria-label="EthoPy" data-md-component="logo">
      
  <img src="../../assets/EthoPy_logo.png" alt="logo">

    </a>
    EthoPy
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ef-lab/ethopy_package" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../creating_custom_components/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../match_port_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Experiment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dot_stimulus_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stimulus
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../multi_port_behavior_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Behavior
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../local_conf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Local Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../task_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Task Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Control Experiment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../plugin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plugins
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../setup_configuration_idx/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup Configuration Index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../logger/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logger Module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../behavior/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Behavior Module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Experiment Module
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Experiment Module
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment" class="md-nav__link">
    <span class="md-ellipsis">
      experiment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass" class="md-nav__link">
    <span class="md-ellipsis">
      ExperimentClass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExperimentClass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.Block" class="md-nav__link">
    <span class="md-ellipsis">
      Block
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Block">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.Block.dict" class="md-nav__link">
    <span class="md-ellipsis">
      dict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.add_performance_metric" class="md-nav__link">
    <span class="md-ellipsis">
      add_performance_metric
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.add_selection_method" class="md-nav__link">
    <span class="md-ellipsis">
      add_selection_method
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.get_keys_from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      get_keys_from_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.is_stopped" class="md-nav__link">
    <span class="md-ellipsis">
      is_stopped
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.log_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      log_conditions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.make_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      make_conditions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.name" class="md-nav__link">
    <span class="md-ellipsis">
      name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.prepare_trial" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_trial
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.push_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      push_conditions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.setup" class="md-nav__link">
    <span class="md-ellipsis">
      setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.start" class="md-nav__link">
    <span class="md-ellipsis">
      start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.stop" class="md-nav__link">
    <span class="md-ellipsis">
      stop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.validate_condition" class="md-nav__link">
    <span class="md-ellipsis">
      validate_condition
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State" class="md-nav__link">
    <span class="md-ellipsis">
      State
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.entry" class="md-nav__link">
    <span class="md-ellipsis">
      entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.exit" class="md-nav__link">
    <span class="md-ellipsis">
      exit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.next" class="md-nav__link">
    <span class="md-ellipsis">
      next
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.StateMachine" class="md-nav__link">
    <span class="md-ellipsis">
      StateMachine
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StateMachine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.StateMachine.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.StateMachine.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interface Module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stimulus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stimulus Module
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/ef-lab/ethopy_package/issues" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Report Issues
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment" class="md-nav__link">
    <span class="md-ellipsis">
      experiment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass" class="md-nav__link">
    <span class="md-ellipsis">
      ExperimentClass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExperimentClass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.Block" class="md-nav__link">
    <span class="md-ellipsis">
      Block
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Block">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.Block.dict" class="md-nav__link">
    <span class="md-ellipsis">
      dict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.add_performance_metric" class="md-nav__link">
    <span class="md-ellipsis">
      add_performance_metric
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.add_selection_method" class="md-nav__link">
    <span class="md-ellipsis">
      add_selection_method
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.get_keys_from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      get_keys_from_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.is_stopped" class="md-nav__link">
    <span class="md-ellipsis">
      is_stopped
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.log_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      log_conditions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.make_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      make_conditions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.name" class="md-nav__link">
    <span class="md-ellipsis">
      name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.prepare_trial" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_trial
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.push_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      push_conditions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.setup" class="md-nav__link">
    <span class="md-ellipsis">
      setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.start" class="md-nav__link">
    <span class="md-ellipsis">
      start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.stop" class="md-nav__link">
    <span class="md-ellipsis">
      stop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.validate_condition" class="md-nav__link">
    <span class="md-ellipsis">
      validate_condition
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State" class="md-nav__link">
    <span class="md-ellipsis">
      State
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.entry" class="md-nav__link">
    <span class="md-ellipsis">
      entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.exit" class="md-nav__link">
    <span class="md-ellipsis">
      exit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.next" class="md-nav__link">
    <span class="md-ellipsis">
      next
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.StateMachine" class="md-nav__link">
    <span class="md-ellipsis">
      StateMachine
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StateMachine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.StateMachine.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.StateMachine.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                



                  


  
  


<h1 id="core-experiment-module">Core Experiment module<a class="headerlink" href="#core-experiment-module" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<a id="ethopy.core.experiment"></a>
    <div class="doc doc-contents first">

        <p>Core experiment module for experiment control.</p>
<p>This module provides the base classes and functionality for running behavioral
experiments. It includes:
- State machine implementation for experiment flow control
- Condition management and randomization
- Trial preparation and execution
- Performance tracking and analysis</p>
<p>The module is built around three main classes:
- State: Base class for implementing experiment states
- StateMachine: Control the flow of the experiment
- ExperimentClass: Base class for experiment implementation</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="ethopy.core.experiment.ExperimentClass" class="doc doc-heading">
            <code>ExperimentClass</code>


<a href="#ethopy.core.experiment.ExperimentClass" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>Parent Experiment.</p>







              <details class="quote">
                <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ExperimentClass</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parent Experiment.&quot;&quot;&quot;</span>

    <span class="n">curr_trial</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the current trial number in the session</span>
    <span class="n">cur_block</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the current block number in the session</span>
    <span class="n">states</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dictionary wiht all states of the experiment</span>
    <span class="n">stims</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dictionary with all stimulus classes</span>
    <span class="n">stim</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># the current condition stimulus class</span>
    <span class="n">sync</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># a boolean to make synchronization available</span>
    <span class="n">un_choices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">curr_cond</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">block_h</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">has_responded</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">resp_ready</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">default_key</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cond_tables</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">quit</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">cur_block_sz</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">setup_conf_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">beh</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">trial_start</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># time in ms of the trial start</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">behavior_class</span><span class="p">,</span> <span class="n">session_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up Experiment.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_h</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stims</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_block_sz</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span> <span class="o">=</span> <span class="n">session_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">session_params</span><span class="p">[</span><span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_key</span><span class="p">,</span>
            <span class="o">**</span><span class="n">session_params</span><span class="p">,</span>
            <span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh</span> <span class="o">=</span> <span class="n">behavior_class</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interface_setup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">load_calibration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_session</span><span class="p">(</span>
            <span class="n">session_params</span><span class="p">,</span> <span class="n">experiment_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cond_tables</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">log_task</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>

        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># fix random seed, it can be overidden in the task file</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_interface_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beh</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">setup_conf_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Interface&quot;</span><span class="p">:</span>  <span class="c1"># noqa: F821</span>
        <span class="n">interface_module</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;interface&quot;</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="s2">&quot;SetupConfiguration&quot;</span><span class="p">,</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;interface&quot;</span><span class="p">],</span>
            <span class="n">key</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">:</span> <span class="n">setup_conf_idx</span><span class="p">},</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interface: </span><span class="si">{</span><span class="n">interface_module</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">interface</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">import_module</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ethopy.interfaces.</span><span class="si">{</span><span class="n">interface_module</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">interface_module</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">interface</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">beh</span><span class="o">=</span><span class="n">beh</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the StateMachine.&quot;&quot;&quot;</span>
        <span class="n">states</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">():</span>  <span class="c1"># Initialize states</span>
            <span class="n">states</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">state</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="n">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)})</span>
        <span class="n">state_control</span> <span class="o">=</span> <span class="n">StateMachine</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">set_operation_status</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">state_control</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the epxeriment.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">is_recording</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for recording to end...&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">closeDatasets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check is experiment should stop.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setup_status</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setup_status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">update_setup_info</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;stop&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_stim_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stim_class</span><span class="p">,</span> <span class="n">stims</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="c1"># get stimulus class name</span>
        <span class="n">stim_name</span> <span class="o">=</span> <span class="n">stim_class</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">stim_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stims</span><span class="p">:</span>
            <span class="n">stim_class</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">stims</span><span class="p">[</span><span class="n">stim_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_class</span>
        <span class="k">return</span> <span class="n">stims</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_keys_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Efficiently extract specific keys from a dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (dict): The input dictionary.</span>
<span class="sd">            keys (list): The list of keys to extract.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A new dictionary with only the specified keys if they exist.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>  <span class="c1"># Convert list to set for O(1) lookup</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">data</span><span class="p">)}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_task_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stim_class</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">exp_name</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;experiment_class&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond_tables</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="n">beh_name</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;behavior_class&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">cond_tables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">cond_tables</span>
            <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
        <span class="p">}</span>
        <span class="n">stim_name</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">:</span> <span class="n">stim_class</span><span class="o">.</span><span class="n">name</span><span class="p">()}</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">exp_name</span><span class="p">,</span> <span class="o">**</span><span class="n">beh_name</span><span class="p">,</span> <span class="o">**</span><span class="n">stim_name</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_conditions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stim_class</span><span class="p">,</span>
        <span class="n">conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">stim_periods</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create conditions by combining stimulus, behavior, and experiment.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;-------------- Make conditions --------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stim_init</span><span class="p">(</span><span class="n">stim_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">)</span>
        <span class="n">used_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># all the keys used from dictionary conditions</span>

        <span class="c1"># Handle stimulus conditions</span>
        <span class="n">stim_conditions</span><span class="p">,</span> <span class="n">stim_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_stim_conditions</span><span class="p">(</span>
            <span class="n">stim_class</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">stim_periods</span>
        <span class="p">)</span>
        <span class="n">used_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stim_keys</span><span class="p">)</span>

        <span class="c1"># Process behavior conditions</span>
        <span class="n">beh_conditions</span><span class="p">,</span> <span class="n">beh_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_behavior_conditions</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
        <span class="n">used_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beh_keys</span><span class="p">)</span>

        <span class="c1"># Process experiment conditions</span>
        <span class="n">exp_conditions</span><span class="p">,</span> <span class="n">exp_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_experiment_conditions</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_task_classes</span><span class="p">(</span><span class="n">stim_class</span><span class="p">),</span> <span class="n">conditions</span>
        <span class="p">)</span>
        <span class="n">used_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">exp_keys</span><span class="p">)</span>

        <span class="c1"># Combine results and handle unused parameters</span>
        <span class="n">partial_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_conditions</span><span class="p">,</span> <span class="n">beh_conditions</span><span class="p">,</span> <span class="n">stim_conditions</span><span class="p">]</span>
        <span class="n">unused_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_unused_parameters</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">used_keys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unused_conditions</span><span class="p">:</span>
            <span class="n">partial_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unused_conditions</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;-----------------------------------------------&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">comb</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">partial_results</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_stim_conditions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">stim_class</span><span class="p">,</span> <span class="n">conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">stim_periods</span><span class="p">:</span> <span class="n">List</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process stimulus-specific conditions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stim_periods</span><span class="p">:</span>
            <span class="n">period_conditions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">stim_periods</span><span class="p">:</span>
                <span class="n">stim_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys_from_dict</span><span class="p">(</span>
                    <span class="n">conditions</span><span class="p">[</span><span class="n">period</span><span class="p">],</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">stim_class</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Stimulus period: </span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s2"> use default conditions:&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">stim_class</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">stim_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">period_conditions</span><span class="p">[</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">(</span><span class="n">stim_dict</span><span class="p">)</span>
                <span class="n">period_conditions</span><span class="p">[</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">[</span>
                    <span class="n">stim_class</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                <span class="p">]</span><span class="o">.</span><span class="n">make_conditions</span><span class="p">(</span><span class="n">period_conditions</span><span class="p">[</span><span class="n">period</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stim_condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">period_conditions</span><span class="p">[</span><span class="n">period</span><span class="p">]):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Stimulus condition </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">format_params_print</span><span class="p">(</span><span class="n">stim_condition</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="n">stim_conditions</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">(</span><span class="n">period_conditions</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stim_conditions</span><span class="p">,</span> <span class="n">stim_periods</span>

        <span class="n">stim_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys_from_dict</span><span class="p">(</span>
            <span class="n">conditions</span><span class="p">,</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">stim_class</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Stimulus use default conditions:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">stim_class</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">stim_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">stim_conditions</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">(</span><span class="n">stim_dict</span><span class="p">)</span>
        <span class="n">stim_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">[</span><span class="n">stim_class</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span><span class="o">.</span><span class="n">make_conditions</span><span class="p">(</span><span class="n">stim_conditions</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stim_condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stim_conditions</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stimulus condition </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">format_params_print</span><span class="p">(</span><span class="n">stim_condition</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stim_conditions</span><span class="p">,</span> <span class="n">stim_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_behavior_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process behavior-related conditions.&quot;&quot;&quot;</span>
        <span class="n">beh_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys_from_dict</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Behavior use default conditions:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">beh_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">beh_conditions</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">(</span><span class="n">beh_dict</span><span class="p">)</span>
        <span class="n">beh_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">make_conditions</span><span class="p">(</span><span class="n">beh_conditions</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">beh_condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">beh_conditions</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Behavior condition </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">format_params_print</span><span class="p">(</span><span class="n">beh_condition</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">beh_conditions</span><span class="p">,</span> <span class="n">beh_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_experiment_conditions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">task_classes</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">conditions</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process experiment-wide conditions.&quot;&quot;&quot;</span>
        <span class="n">exp_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys_from_dict</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">exp_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">task_classes</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Experiment use default conditions:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">exp_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">exp_conditions</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">(</span><span class="n">exp_dict</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">exp_conditions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_condition</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
            <span class="n">cond</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_key</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">cond</span><span class="p">})</span>
        <span class="n">cond_tables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Condition.&quot;</span> <span class="o">+</span> <span class="n">table</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond_tables</span><span class="p">]</span>
        <span class="n">conditions_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_conditions</span><span class="p">(</span>
            <span class="n">exp_conditions</span><span class="p">,</span> <span class="n">condition_tables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Condition&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cond_tables</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exp_condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exp_conditions</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Experiment condition </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">format_params_print</span><span class="p">(</span><span class="n">exp_condition</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">conditions_list</span><span class="p">,</span> <span class="n">exp_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_unused_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">used_keys</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process any unused parameters.&quot;&quot;&quot;</span>
        <span class="n">unused_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">conditions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">used_keys</span>
        <span class="k">if</span> <span class="n">unused_keys</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Keys: </span><span class="si">{</span><span class="n">unused_keys</span><span class="si">}</span><span class="s2"> are in condition but are not used from &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Experiment, Behavior or Stimulus&quot;</span>
            <span class="p">)</span>
            <span class="n">unused_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys_from_dict</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">unused_keys</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">factorize</span><span class="p">(</span><span class="n">unused_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate a condition dictionary against the required fields.</span>

<span class="sd">        Args:</span>
<span class="sd">            condition (Dict): The condition dictionary to validate.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If required fields are missing from the condition.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">missing_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_fields</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing experiment required fields: </span><span class="si">{</span><span class="n">missing_fields</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">push_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the experimental conditions and initializes related data structures.</span>

<span class="sd">        This method takes a list of condition dictionaries, prepares data structures</span>
<span class="sd">        for tracking choices, blocks, and the current condition.  It also determines</span>
<span class="sd">        unique choice hashes based on the response condition and difficulty.</span>

<span class="sd">        Args:</span>
<span class="sd">            conditions: A list of dictionaries, where each dictionary</span>
<span class="sd">                represents an experimental condition.  Each condition</span>
<span class="sd">                dictionary is expected to contain at least a &quot;difficulty&quot;</span>
<span class="sd">                key.  If a `resp_cond` key (or the default &quot;response_port&quot;)</span>
<span class="sd">                is present, it&#39;s used to create unique choice hashes.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of conditions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="n">conditions</span>
        <span class="n">resp_cond</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;resp_cond&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;resp_cond&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">else</span> <span class="s2">&quot;response_port&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;difficulty&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">resp_cond</span> <span class="ow">in</span> <span class="n">cond</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">make_hash</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="n">resp_cond</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;difficulty&quot;</span><span class="p">]])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">un_choices</span><span class="p">,</span> <span class="n">un_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">un_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">un_idx</span><span class="p">]</span>
        <span class="c1">#  select random condition for first trial initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare trial conditions, stimuli and update trial index.&quot;&quot;&quot;</span>
        <span class="n">old_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_new_cond</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">thread_end</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;stimulus_class&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_cond</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">or</span> <span class="n">old_cond</span><span class="p">[</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;stimulus_class&quot;</span> <span class="ow">in</span> <span class="n">old_cond</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">]]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;setting up stimulus&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;stimuli is done&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">update_trial_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trial_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger_timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="s2">&quot;Trial&quot;</span><span class="p">,</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">cond_hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;cond_hash&quot;</span><span class="p">],</span> <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_start</span><span class="p">),</span>
            <span class="n">priority</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Name of experiment class.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_cond_hash</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
        <span class="n">hash_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">:</span> <span class="n">dj</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
        <span class="n">condition_tables</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make unique hash based on all fields from condition tables.&quot;&quot;&quot;</span>
        <span class="c1"># get all fields from condition tables except hash</span>
        <span class="n">fields_key</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span>
            <span class="k">for</span> <span class="n">ctable</span> <span class="ow">in</span> <span class="n">condition_tables</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">get_table_keys</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ctable</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">fields_key</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">hash_field</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
            <span class="c1"># find all dependant fields and generate hash</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fields_key</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">condition</span><span class="p">}</span>
            <span class="n">condition</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">hash_field</span><span class="p">:</span> <span class="n">make_hash</span><span class="p">(</span><span class="n">key</span><span class="p">)})</span>
        <span class="k">return</span> <span class="n">conditions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_conditions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">conditions</span><span class="p">,</span>
        <span class="n">condition_tables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;experiment&quot;</span><span class="p">,</span>
        <span class="n">hash_field</span><span class="o">=</span><span class="s2">&quot;cond_hash&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log experimental conditions to specified tables with hashes tracking.</span>

<span class="sd">        Args:</span>
<span class="sd">            conditions (List): List of condition dictionaries to log</span>
<span class="sd">            condition_tables (List): List of table names to log to</span>
<span class="sd">            schema (db.shcema): Database schema name</span>
<span class="sd">            hash_field (str): Name of the hash field</span>
<span class="sd">            priority (int): for the insertion order of the logger</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of processed conditions with added hashes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">conditions</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">condition_tables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">condition_tables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Condition&quot;</span><span class="p">]</span>

        <span class="n">conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_cond_hash</span><span class="p">(</span>
            <span class="n">conditions</span><span class="p">,</span> <span class="n">hash_field</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">condition_tables</span>
        <span class="p">)</span>

        <span class="n">processed_conditions</span> <span class="o">=</span> <span class="n">conditions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">processed_conditions</span><span class="p">:</span>
            <span class="n">_priority</span> <span class="o">=</span> <span class="n">priority</span>
            <span class="c1"># insert conditions fields to the correspond table</span>
            <span class="k">for</span> <span class="n">ctable</span> <span class="ow">in</span> <span class="n">condition_tables</span><span class="p">:</span>
                <span class="c1"># Get table metadata</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">get_table_keys</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ctable</span><span class="p">))</span>
                <span class="n">primary_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">get_table_keys</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ctable</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">core</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">primary_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">hash_field</span><span class="p">]</span>

                <span class="c1"># Validate condition has all required fields</span>
                <span class="n">missing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">condition</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">ctable</span><span class="si">}</span><span class="s2">, Missing keys:</span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># check if there is a primary key which is not hash and it is iterable</span>
                <span class="k">if</span> <span class="n">core</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="n">core</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                    <span class="c1"># TODO make a function for this and clarify it</span>
                    <span class="c1"># If any of the primary keys is iterable all the rest should be.</span>
                    <span class="c1"># The first element of the iterable will be matched with the first</span>
                    <span class="c1"># element of the rest of the keys</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="n">core</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
                        <span class="n">cond_key</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                                <span class="n">cond_key</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">cond_key</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                            <span class="n">table</span><span class="o">=</span><span class="n">ctable</span><span class="p">,</span>
                            <span class="nb">tuple</span><span class="o">=</span><span class="n">cond_key</span><span class="p">,</span>
                            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                            <span class="n">priority</span><span class="o">=</span><span class="n">_priority</span><span class="p">,</span>
                        <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                        <span class="n">table</span><span class="o">=</span><span class="n">ctable</span><span class="p">,</span> <span class="nb">tuple</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">_priority</span>
                    <span class="p">)</span>

                <span class="c1"># Increment the priority for each subsequent table</span>
                <span class="c1"># to ensure they are inserted in the correct order</span>
                <span class="n">_priority</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">processed_conditions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_anti_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">choice_h</span><span class="p">,</span> <span class="n">un_choices</span><span class="p">):</span>
        <span class="n">choice_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">make_hash</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">choice_h</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;bias_window&quot;</span><span class="p">]:]]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choice_h</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;bias_window&quot;</span><span class="p">]:</span>
            <span class="n">choice_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choices</span>
        <span class="n">fixed_p</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">choice_h</span> <span class="o">==</span> <span class="n">un</span><span class="p">)</span> <span class="k">for</span> <span class="n">un</span> <span class="ow">in</span> <span class="n">un_choices</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fixed_p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fixed_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_p</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">un_choices</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">fixed_p</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fixed_p</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_new_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get next condition based on trial selection method.&quot;&quot;&quot;</span>
        <span class="n">selection_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;trial_selection&quot;</span><span class="p">]</span>
        <span class="n">selection_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;fixed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_selection</span><span class="p">,</span>
            <span class="s2">&quot;block&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_selection</span><span class="p">,</span>
            <span class="s2">&quot;random&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_selection</span><span class="p">,</span>
            <span class="s2">&quot;staircase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staircase_selection</span><span class="p">,</span>
            <span class="s2">&quot;biased&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_biased_selection</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">handler</span> <span class="o">=</span> <span class="n">selection_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">selection_method</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="o">=</span> <span class="n">handler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selection method &#39;</span><span class="si">{</span><span class="n">selection_method</span><span class="si">}</span><span class="s2">&#39; not implemented!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fixed_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select next condition by popping from ordered list.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_block_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select random condition from a block.</span>

<span class="sd">        Select a condition from a block of conditions until all</span>
<span class="sd">        conditions has been selected, then repeat them randomnly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">))</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">cond</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_random_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select random condition from available conditions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_block_difficulty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perf</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update block difficulty based on performance.</span>

<span class="sd">        Args:</span>
<span class="sd">            perf: Current performance metric</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block_sz</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;staircase_window&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">perf</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;stair_up&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;next_up&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_block_sz</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">update_setup_info</span><span class="p">({</span><span class="s2">&quot;difficulty&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">perf</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;stair_down&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;next_down&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_block_sz</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">update_setup_info</span><span class="p">({</span><span class="s2">&quot;difficulty&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_valid_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition_idx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get list of valid conditions based on condition index.</span>

<span class="sd">        Args:</span>
<span class="sd">            condition_idx: Boolean array indicating valid conditions</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of valid condition dictionaries</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">,</span> <span class="n">condition_idx</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_staircase_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select next condition using staircase method.&quot;&quot;&quot;</span>
        <span class="c1"># Get performance metrics</span>
        <span class="n">perf</span><span class="p">,</span> <span class="n">choice_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_performance</span><span class="p">()</span>

        <span class="c1"># Update block size if there was a choice in last trial</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">choice_history</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">choice_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur_block_sz</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Update difficulty if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_block_difficulty</span><span class="p">(</span><span class="n">perf</span><span class="p">)</span>

        <span class="c1"># Select condition based on current block and anti-bias</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;antibias&quot;</span><span class="p">]:</span>
            <span class="n">valid_choices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">un_choices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">un_blocks</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span><span class="p">]</span>
            <span class="n">anti_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anti_bias</span><span class="p">(</span><span class="n">choice_h</span><span class="p">,</span> <span class="n">valid_choices</span><span class="p">)</span>
            <span class="n">condition_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">==</span> <span class="n">anti_bias</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">condition_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span>

        <span class="n">valid_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_valid_conditions</span><span class="p">(</span><span class="n">condition_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_conditions</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_biased_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select next condition using anti-bias method.&quot;&quot;&quot;</span>
        <span class="n">perf</span><span class="p">,</span> <span class="n">choice_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_performance</span><span class="p">()</span>
        <span class="n">anti_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anti_bias</span><span class="p">(</span><span class="n">choice_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">un_choices</span><span class="p">)</span>
        <span class="n">condition_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">==</span> <span class="n">anti_bias</span>
        <span class="n">valid_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_valid_conditions</span><span class="p">(</span><span class="n">condition_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_conditions</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_selection_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new trial selection method.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Name of the selection method</span>
<span class="sd">            handler: Function that returns next condition</span>

<span class="sd">        Example:</span>
<span class="sd">            def my_selection_method(self):</span>
<span class="sd">                # Custom selection logic</span>
<span class="sd">                return selected_condition</span>

<span class="sd">            experiment.add_selection_method(&#39;custom&#39;, my_selection_method)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_selection&quot;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_selection&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added new selection method: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selection method &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already exists&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate performance metrics based on trial history.&quot;&quot;&quot;</span>
        <span class="n">rewards</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_valid_trial_data</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rewards</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>  <span class="c1"># Check if there are any valid trials</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="p">[]</span>

        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;staircase_window&quot;</span><span class="p">]</span>
        <span class="n">recent_rewards</span> <span class="o">=</span> <span class="n">rewards</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:]</span>
        <span class="n">recent_choices</span> <span class="o">=</span> <span class="n">choices</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:]</span>
        <span class="n">recent_blocks</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:]</span> <span class="k">if</span> <span class="n">blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metric</span><span class="p">(</span>
            <span class="n">recent_rewards</span><span class="p">,</span> <span class="n">recent_choices</span><span class="p">,</span> <span class="n">recent_blocks</span>
        <span class="p">)</span>

        <span class="n">choice_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_choice_history</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="n">blocks</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">staircase_window: </span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;rewards: </span><span class="si">{</span><span class="n">recent_rewards</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;choices: </span><span class="si">{</span><span class="n">recent_choices</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;blocks: </span><span class="si">{</span><span class="n">recent_blocks</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;performace: </span><span class="si">{</span><span class="n">performance</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">performance</span><span class="p">,</span> <span class="n">choice_history</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_valid_trial_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract trials that are either punish or reward.</span>

<span class="sd">        rewards: reward amount given at trials that have been rewarded else nan</span>
<span class="sd">        choices: selected port in reward &amp; punish trials</span>
<span class="sd">        blocks: block index in each trial that is reward or punish</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
            <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">reward_history</span><span class="p">),</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">punish_history</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">rewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">reward_history</span><span class="p">)[</span><span class="n">valid_idx</span><span class="p">]</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">choice_history</span><span class="p">)[</span><span class="n">valid_idx</span><span class="p">])</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_h</span><span class="p">)[</span><span class="n">valid_idx</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_h</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">blocks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_accuracy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">rewards</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate accuracy from trial data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_dprime</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">rewards</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate d-prime from trial data.&quot;&quot;&quot;</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">c</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="n">rewards</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_true</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_metric</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">rewards</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate performance metric specified in current condition.&quot;&quot;&quot;</span>
        <span class="n">metric_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_accuracy</span><span class="p">,</span>
            <span class="s2">&quot;dprime&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_dprime</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">handler</span> <span class="o">=</span> <span class="n">metric_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">blocks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Performance metric &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; not implemented!&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_choice_history</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create choice history with difficulty levels.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[[</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="n">blocks</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_performance_metric</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span> <span class="nb">float</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new performance metric calculation method.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Name of the metric</span>
<span class="sd">            handler: Function that takes ValidTrials and returns performance score</span>

<span class="sd">        Example:</span>
<span class="sd">            def calculate_custom_metric(trials):</span>
<span class="sd">                # Custom metric calculation</span>
<span class="sd">                return score</span>

<span class="sd">            experiment.add_performance_metric(&#39;custom&#39;, calculate_custom_metric)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added new performance metric: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance metric &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already exists&quot;</span><span class="p">)</span>

    <span class="nd">@dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Block</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A class representing a block of trials in an experiment.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            difficulty (int): The difficulty level of the block. Default is 0.</span>
<span class="sd">            stair_up (float): Threshold given to compare if performance is higher in</span>
<span class="sd">                order to go to the next_up difficulty. Default is 0.7.</span>
<span class="sd">            stair_down (float): Threshold given to compare if performance is smaller in</span>
<span class="sd">                order to go to the next_down difficulty. Default is 0.7.</span>
<span class="sd">            next_up (int): The difficulty level to go to if perf&gt;stair_up. Default is 0.</span>
<span class="sd">            next_down (int): The difficulty level to go to if perf&lt;stair_down.</span>
<span class="sd">                Default is 0.</span>
<span class="sd">            staircase_window (int): The window size for the staircase procedure.</span>
<span class="sd">                Default is 20.</span>
<span class="sd">            bias_window (int): The window size for bias correction. Default is 5.</span>
<span class="sd">            trial_selection (str): The method for selecting trials. Default is &quot;fixed&quot;.</span>
<span class="sd">            metric (str): The metric used for evaluating performance. Default is</span>
<span class="sd">                &quot;accuracy&quot;.</span>
<span class="sd">            antibias (bool): Whether to apply antibias correction. Default is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: A dictionary containing the block parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">difficulty</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">stair_up</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">stair_down</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.55</span><span class="p">)</span>
        <span class="n">next_up</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">next_down</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">staircase_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">bias_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">trial_selection</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;fixed&quot;</span><span class="p">)</span>
        <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
        <span class="n">antibias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Rerurn parameters as dictionary.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="ethopy.core.experiment.ExperimentClass.Block" class="doc doc-heading">
            <code>Block</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#ethopy.core.experiment.ExperimentClass.Block" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">


        <p>A class representing a block of trials in an experiment.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.ExperimentClass.Block.difficulty">difficulty</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The difficulty level of the block. Default is 0.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.ExperimentClass.Block.stair_up">stair_up</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold given to compare if performance is higher in
order to go to the next_up difficulty. Default is 0.7.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.ExperimentClass.Block.stair_down">stair_down</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold given to compare if performance is smaller in
order to go to the next_down difficulty. Default is 0.7.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.ExperimentClass.Block.next_up">next_up</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The difficulty level to go to if perf&gt;stair_up. Default is 0.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.ExperimentClass.Block.next_down">next_down</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The difficulty level to go to if perf&lt;stair_down.
Default is 0.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.ExperimentClass.Block.staircase_window">staircase_window</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The window size for the staircase procedure.
Default is 20.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.ExperimentClass.Block.bias_window">bias_window</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The window size for bias correction. Default is 5.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.ExperimentClass.Block.trial_selection">trial_selection</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The method for selecting trials. Default is "fixed".</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.ExperimentClass.Block.metric">metric</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The metric used for evaluating performance. Default is
"accuracy".</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.ExperimentClass.Block.antibias">antibias</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to apply antibias correction. Default is True.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the block parameters.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Block</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class representing a block of trials in an experiment.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        difficulty (int): The difficulty level of the block. Default is 0.</span>
<span class="sd">        stair_up (float): Threshold given to compare if performance is higher in</span>
<span class="sd">            order to go to the next_up difficulty. Default is 0.7.</span>
<span class="sd">        stair_down (float): Threshold given to compare if performance is smaller in</span>
<span class="sd">            order to go to the next_down difficulty. Default is 0.7.</span>
<span class="sd">        next_up (int): The difficulty level to go to if perf&gt;stair_up. Default is 0.</span>
<span class="sd">        next_down (int): The difficulty level to go to if perf&lt;stair_down.</span>
<span class="sd">            Default is 0.</span>
<span class="sd">        staircase_window (int): The window size for the staircase procedure.</span>
<span class="sd">            Default is 20.</span>
<span class="sd">        bias_window (int): The window size for bias correction. Default is 5.</span>
<span class="sd">        trial_selection (str): The method for selecting trials. Default is &quot;fixed&quot;.</span>
<span class="sd">        metric (str): The metric used for evaluating performance. Default is</span>
<span class="sd">            &quot;accuracy&quot;.</span>
<span class="sd">        antibias (bool): Whether to apply antibias correction. Default is True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict: A dictionary containing the block parameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">difficulty</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">stair_up</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">stair_down</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.55</span><span class="p">)</span>
    <span class="n">next_up</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">next_down</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">staircase_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">bias_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">trial_selection</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;fixed&quot;</span><span class="p">)</span>
    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
    <span class="n">antibias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rerurn parameters as dictionary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ethopy.core.experiment.ExperimentClass.Block.dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="nb">dict</span><span class="p">()</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.Block.dict" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Rerurn parameters as dictionary.</p>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rerurn parameters as dictionary.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.ExperimentClass.add_performance_metric" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_performance_metric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.add_performance_metric" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add a new performance metric calculation method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the metric</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>handler</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="numpy.ndarray">ndarray</span>, <span title="numpy.ndarray">ndarray</span>, <span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]], <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function that takes ValidTrials and returns performance score</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>def calculate_custom_metric(trials):
    # Custom metric calculation
    return score</p>
<p>experiment.add_performance_metric('custom', calculate_custom_metric)</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_performance_metric</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span> <span class="nb">float</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new performance metric calculation method.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Name of the metric</span>
<span class="sd">        handler: Function that takes ValidTrials and returns performance score</span>

<span class="sd">    Example:</span>
<span class="sd">        def calculate_custom_metric(trials):</span>
<span class="sd">            # Custom metric calculation</span>
<span class="sd">            return score</span>

<span class="sd">        experiment.add_performance_metric(&#39;custom&#39;, calculate_custom_metric)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added new performance metric: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance metric &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already exists&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.ExperimentClass.add_selection_method" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_selection_method</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.add_selection_method" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add a new trial selection method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the selection method</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>handler</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[], <span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function that returns next condition</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>def my_selection_method(self):
    # Custom selection logic
    return selected_condition</p>
<p>experiment.add_selection_method('custom', my_selection_method)</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_selection_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new trial selection method.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Name of the selection method</span>
<span class="sd">        handler: Function that returns next condition</span>

<span class="sd">    Example:</span>
<span class="sd">        def my_selection_method(self):</span>
<span class="sd">            # Custom selection logic</span>
<span class="sd">            return selected_condition</span>

<span class="sd">        experiment.add_selection_method(&#39;custom&#39;, my_selection_method)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_selection&quot;</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_selection&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added new selection method: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selection method &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already exists&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.ExperimentClass.get_keys_from_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_keys_from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.get_keys_from_dict" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Efficiently extract specific keys from a dictionary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input dictionary.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keys</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of keys to extract.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new dictionary with only the specified keys if they exist.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_keys_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Efficiently extract specific keys from a dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (dict): The input dictionary.</span>
<span class="sd">        keys (list): The list of keys to extract.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A new dictionary with only the specified keys if they exist.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>  <span class="c1"># Convert list to set for O(1) lookup</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">data</span><span class="p">)}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.ExperimentClass.is_stopped" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_stopped</span><span class="p">()</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.is_stopped" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Check is experiment should stop.</p>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check is experiment should stop.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setup_status</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setup_status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">update_setup_info</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;stop&quot;</span><span class="p">})</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.ExperimentClass.log_conditions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">log_conditions</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">condition_tables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="n">hash_field</span><span class="o">=</span><span class="s1">&#39;cond_hash&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.log_conditions" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Log experimental conditions to specified tables with hashes tracking.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>conditions</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of condition dictionaries to log</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>condition_tables</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of table names to log to</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>schema</code>
            </td>
            <td>
                  <code><span title="db.shcema">shcema</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Database schema name</p>
              </div>
            </td>
            <td>
                  <code>&#39;experiment&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hash_field</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the hash field</p>
              </div>
            </td>
            <td>
                  <code>&#39;cond_hash&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>priority</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>for the insertion order of the logger</p>
              </div>
            </td>
            <td>
                  <code>2</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of processed conditions with added hashes</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log_conditions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">conditions</span><span class="p">,</span>
    <span class="n">condition_tables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;experiment&quot;</span><span class="p">,</span>
    <span class="n">hash_field</span><span class="o">=</span><span class="s2">&quot;cond_hash&quot;</span><span class="p">,</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log experimental conditions to specified tables with hashes tracking.</span>

<span class="sd">    Args:</span>
<span class="sd">        conditions (List): List of condition dictionaries to log</span>
<span class="sd">        condition_tables (List): List of table names to log to</span>
<span class="sd">        schema (db.shcema): Database schema name</span>
<span class="sd">        hash_field (str): Name of the hash field</span>
<span class="sd">        priority (int): for the insertion order of the logger</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of processed conditions with added hashes</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">conditions</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">condition_tables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">condition_tables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Condition&quot;</span><span class="p">]</span>

    <span class="n">conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_cond_hash</span><span class="p">(</span>
        <span class="n">conditions</span><span class="p">,</span> <span class="n">hash_field</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">condition_tables</span>
    <span class="p">)</span>

    <span class="n">processed_conditions</span> <span class="o">=</span> <span class="n">conditions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">processed_conditions</span><span class="p">:</span>
        <span class="n">_priority</span> <span class="o">=</span> <span class="n">priority</span>
        <span class="c1"># insert conditions fields to the correspond table</span>
        <span class="k">for</span> <span class="n">ctable</span> <span class="ow">in</span> <span class="n">condition_tables</span><span class="p">:</span>
            <span class="c1"># Get table metadata</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">get_table_keys</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ctable</span><span class="p">))</span>
            <span class="n">primary_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">get_table_keys</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ctable</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">core</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">primary_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">hash_field</span><span class="p">]</span>

            <span class="c1"># Validate condition has all required fields</span>
            <span class="n">missing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">condition</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">ctable</span><span class="si">}</span><span class="s2">, Missing keys:</span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># check if there is a primary key which is not hash and it is iterable</span>
            <span class="k">if</span> <span class="n">core</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="n">core</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                <span class="c1"># TODO make a function for this and clarify it</span>
                <span class="c1"># If any of the primary keys is iterable all the rest should be.</span>
                <span class="c1"># The first element of the iterable will be matched with the first</span>
                <span class="c1"># element of the rest of the keys</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="n">core</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
                    <span class="n">cond_key</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                            <span class="n">cond_key</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cond_key</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                        <span class="n">table</span><span class="o">=</span><span class="n">ctable</span><span class="p">,</span>
                        <span class="nb">tuple</span><span class="o">=</span><span class="n">cond_key</span><span class="p">,</span>
                        <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                        <span class="n">priority</span><span class="o">=</span><span class="n">_priority</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                    <span class="n">table</span><span class="o">=</span><span class="n">ctable</span><span class="p">,</span> <span class="nb">tuple</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">_priority</span>
                <span class="p">)</span>

            <span class="c1"># Increment the priority for each subsequent table</span>
            <span class="c1"># to ensure they are inserted in the correct order</span>
            <span class="n">_priority</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">processed_conditions</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.ExperimentClass.make_conditions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_conditions</span><span class="p">(</span><span class="n">stim_class</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">stim_periods</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.make_conditions" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Create conditions by combining stimulus, behavior, and experiment.</p>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_conditions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">stim_class</span><span class="p">,</span>
    <span class="n">conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">stim_periods</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create conditions by combining stimulus, behavior, and experiment.&quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;-------------- Make conditions --------------&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stim_init</span><span class="p">(</span><span class="n">stim_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">)</span>
    <span class="n">used_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># all the keys used from dictionary conditions</span>

    <span class="c1"># Handle stimulus conditions</span>
    <span class="n">stim_conditions</span><span class="p">,</span> <span class="n">stim_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_stim_conditions</span><span class="p">(</span>
        <span class="n">stim_class</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">stim_periods</span>
    <span class="p">)</span>
    <span class="n">used_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stim_keys</span><span class="p">)</span>

    <span class="c1"># Process behavior conditions</span>
    <span class="n">beh_conditions</span><span class="p">,</span> <span class="n">beh_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_behavior_conditions</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
    <span class="n">used_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beh_keys</span><span class="p">)</span>

    <span class="c1"># Process experiment conditions</span>
    <span class="n">exp_conditions</span><span class="p">,</span> <span class="n">exp_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_experiment_conditions</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_task_classes</span><span class="p">(</span><span class="n">stim_class</span><span class="p">),</span> <span class="n">conditions</span>
    <span class="p">)</span>
    <span class="n">used_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">exp_keys</span><span class="p">)</span>

    <span class="c1"># Combine results and handle unused parameters</span>
    <span class="n">partial_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_conditions</span><span class="p">,</span> <span class="n">beh_conditions</span><span class="p">,</span> <span class="n">stim_conditions</span><span class="p">]</span>
    <span class="n">unused_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_unused_parameters</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">used_keys</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">unused_conditions</span><span class="p">:</span>
        <span class="n">partial_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unused_conditions</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;-----------------------------------------------&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">comb</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">partial_results</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.ExperimentClass.name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">name</span><span class="p">()</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.name" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Name of experiment class.</p>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name of experiment class.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.ExperimentClass.prepare_trial" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_trial</span><span class="p">()</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.prepare_trial" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Prepare trial conditions, stimuli and update trial index.</p>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare trial conditions, stimuli and update trial index.&quot;&quot;&quot;</span>
    <span class="n">old_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_get_new_cond</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">thread_end</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">&quot;stimulus_class&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_cond</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="ow">or</span> <span class="n">old_cond</span><span class="p">[</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;stimulus_class&quot;</span> <span class="ow">in</span> <span class="n">old_cond</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">]]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;setting up stimulus&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;stimuli is done&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">update_trial_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">trial_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger_timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="s2">&quot;Trial&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">cond_hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;cond_hash&quot;</span><span class="p">],</span> <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_start</span><span class="p">),</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.ExperimentClass.push_conditions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">push_conditions</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.push_conditions" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Set the experimental conditions and initializes related data structures.</p>
<p>This method takes a list of condition dictionaries, prepares data structures
for tracking choices, blocks, and the current condition.  It also determines
unique choice hashes based on the response condition and difficulty.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>conditions</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of dictionaries, where each dictionary
represents an experimental condition.  Each condition
dictionary is expected to contain at least a "difficulty"
key.  If a <code>resp_cond</code> key (or the default "response_port")
is present, it's used to create unique choice hashes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">push_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the experimental conditions and initializes related data structures.</span>

<span class="sd">    This method takes a list of condition dictionaries, prepares data structures</span>
<span class="sd">    for tracking choices, blocks, and the current condition.  It also determines</span>
<span class="sd">    unique choice hashes based on the response condition and difficulty.</span>

<span class="sd">    Args:</span>
<span class="sd">        conditions: A list of dictionaries, where each dictionary</span>
<span class="sd">            represents an experimental condition.  Each condition</span>
<span class="sd">            dictionary is expected to contain at least a &quot;difficulty&quot;</span>
<span class="sd">            key.  If a `resp_cond` key (or the default &quot;response_port&quot;)</span>
<span class="sd">            is present, it&#39;s used to create unique choice hashes.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of conditions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="n">conditions</span>
    <span class="n">resp_cond</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;resp_cond&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;resp_cond&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">else</span> <span class="s2">&quot;response_port&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;difficulty&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">resp_cond</span> <span class="ow">in</span> <span class="n">cond</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">make_hash</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="n">resp_cond</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;difficulty&quot;</span><span class="p">]])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">un_choices</span><span class="p">,</span> <span class="n">un_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">un_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">un_idx</span><span class="p">]</span>
    <span class="c1">#  select random condition for first trial initialization</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
        <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.ExperimentClass.setup" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">setup</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">behavior_class</span><span class="p">,</span> <span class="n">session_params</span><span class="p">)</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.setup" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Set up Experiment.</p>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">behavior_class</span><span class="p">,</span> <span class="n">session_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up Experiment.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">block_h</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stims</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cur_block_sz</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span> <span class="o">=</span> <span class="n">session_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">session_params</span><span class="p">[</span><span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_key</span><span class="p">,</span>
        <span class="o">**</span><span class="n">session_params</span><span class="p">,</span>
        <span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beh</span> <span class="o">=</span> <span class="n">behavior_class</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interface_setup</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">load_calibration</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_session</span><span class="p">(</span>
        <span class="n">session_params</span><span class="p">,</span> <span class="n">experiment_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cond_tables</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">log_task</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">session_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># fix random seed, it can be overidden in the task file</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.ExperimentClass.start" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">start</span><span class="p">()</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.start" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Start the StateMachine.</p>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start the StateMachine.&quot;&quot;&quot;</span>
    <span class="n">states</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">():</span>  <span class="c1"># Initialize states</span>
        <span class="n">states</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">state</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="n">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)})</span>
    <span class="n">state_control</span> <span class="o">=</span> <span class="n">StateMachine</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">set_operation_status</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">state_control</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.ExperimentClass.stop" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">stop</span><span class="p">()</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.stop" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Stop the epxeriment.</p>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stop the epxeriment.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">is_recording</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for recording to end...&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">closeDatasets</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.ExperimentClass.validate_condition" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_condition</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span></code>

<a href="#ethopy.core.experiment.ExperimentClass.validate_condition" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Validate a condition dictionary against the required fields.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>condition</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The condition dictionary to validate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required fields are missing from the condition.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate a condition dictionary against the required fields.</span>

<span class="sd">    Args:</span>
<span class="sd">        condition (Dict): The condition dictionary to validate.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If required fields are missing from the condition.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">missing_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_fields</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing_fields</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing experiment required fields: </span><span class="si">{</span><span class="n">missing_fields</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ethopy.core.experiment.State" class="doc doc-heading">
            <code>State</code>


<a href="#ethopy.core.experiment.State" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>Base class for implementing experiment states.</p>
<p>This class provides the template for creating states in the experiment state
machine. Each state should inherit from this class and implement the required
methods.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.State.state_timer">state_timer</span></code></td>
            <td>
                  <code><span title="ethopy.utils.timer.Timer">Timer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timer instance shared across all states</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.State.__shared_state">__shared_state</span></code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing shared state variables</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for implementing experiment states.</span>

<span class="sd">    This class provides the template for creating states in the experiment state</span>
<span class="sd">    machine. Each state should inherit from this class and implement the required</span>
<span class="sd">    methods.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        state_timer: Timer instance shared across all states</span>
<span class="sd">        __shared_state: Dictionary containing shared state variables</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">state_timer</span><span class="p">:</span> <span class="n">Timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
    <span class="n">__shared_state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ExperimentClass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize state with optional parent experiment.</span>

<span class="sd">        Args:</span>
<span class="sd">            parent: Parent experiment instance this state belongs to</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__shared_state</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">entry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute actions when entering this state.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the main state logic.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the next state to transition to.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Name of the next state to transition to</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If next() is not implemented by child class</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;next not implemented&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute actions when exiting this state.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.State.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#ethopy.core.experiment.State.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize state with optional parent experiment.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>parent</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="ExperimentClass (ethopy.core.experiment.ExperimentClass)" href="#ethopy.core.experiment.ExperimentClass">ExperimentClass</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parent experiment instance this state belongs to</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ExperimentClass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize state with optional parent experiment.</span>

<span class="sd">    Args:</span>
<span class="sd">        parent: Parent experiment instance this state belongs to</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__shared_state</span>
    <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.State.entry" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">entry</span><span class="p">()</span></code>

<a href="#ethopy.core.experiment.State.entry" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Execute actions when entering this state.</p>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">entry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute actions when entering this state.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.State.exit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">exit</span><span class="p">()</span></code>

<a href="#ethopy.core.experiment.State.exit" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Execute actions when exiting this state.</p>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute actions when exiting this state.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.State.next" class="doc doc-heading">
            <code class="highlight language-python"><span class="nb">next</span><span class="p">()</span></code>

<a href="#ethopy.core.experiment.State.next" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Determine the next state to transition to.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the next state to transition to</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If next() is not implemented by child class</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine the next state to transition to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Name of the next state to transition to</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If next() is not implemented by child class</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;next not implemented&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.State.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

<a href="#ethopy.core.experiment.State.run" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Execute the main state logic.</p>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the main state logic.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="ethopy.core.experiment.StateMachine" class="doc doc-heading">
            <code>StateMachine</code>


<a href="#ethopy.core.experiment.StateMachine" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>State machine implementation for experiment control flow.</p>
<p>Manages transitions between experiment states and ensures proper execution
of state entry/exit hooks. The state machine runs until it reaches the exit
state.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.StateMachine.states">states</span></code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="State (ethopy.core.experiment.State)" href="#ethopy.core.experiment.State">State</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mapping of state names to state instances</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.StateMachine.futureState">futureState</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="State (ethopy.core.experiment.State)" href="#ethopy.core.experiment.State">State</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Next state to transition to</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.StateMachine.currentState">currentState</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="State (ethopy.core.experiment.State)" href="#ethopy.core.experiment.State">State</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Currently executing state</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="ethopy.core.experiment.StateMachine.exitState">exitState</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="State (ethopy.core.experiment.State)" href="#ethopy.core.experiment.State">State</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Final state that ends the state machine</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StateMachine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;State machine implementation for experiment control flow.</span>

<span class="sd">    Manages transitions between experiment states and ensures proper execution</span>
<span class="sd">    of state entry/exit hooks. The state machine runs until it reaches the exit</span>
<span class="sd">    state.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        states (Dict[str, State]): Mapping of state names to state instances</span>
<span class="sd">        futureState (State): Next state to transition to</span>
<span class="sd">        currentState (State): Currently executing state</span>
<span class="sd">        exitState (State): Final state that ends the state machine</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">State</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the state machine.</span>

<span class="sd">        Args:</span>
<span class="sd">            states: Dictionary mapping state names to state instances</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If required states (Entry, Exit) are missing</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;Entry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">states</span> <span class="ow">or</span> <span class="s2">&quot;Exit&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;StateMachine requires Entry and Exit states&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;Entry&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;Entry&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exitState</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;Exit&quot;</span><span class="p">]</span>

    <span class="c1"># # # # Main state loop # # # # #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the state machine until reaching exit state.</span>

<span class="sd">        The machine will:</span>
<span class="sd">        1. Check for state transition</span>
<span class="sd">        2. Execute exit hook of current state if transitioning</span>
<span class="sd">        3. Execute entry hook of new state if transitioning</span>
<span class="sd">        4. Execute the current state&#39;s main logic</span>
<span class="sd">        5. Determine next state</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If a state requests transition to non-existent state</span>
<span class="sd">            RuntimeError: If a state&#39;s next() method raises an exception</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitState</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">entry</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

                <span class="n">next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">next_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid state transition to: </span><span class="si">{</span><span class="n">next_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">next_state</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exitState</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;State machine error in state</span>
<span class="s2">                    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.StateMachine.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">states</span><span class="p">)</span></code>

<a href="#ethopy.core.experiment.StateMachine.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the state machine.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>states</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="State (ethopy.core.experiment.State)" href="#ethopy.core.experiment.State">State</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping state names to state instances</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required states (Entry, Exit) are missing</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">State</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the state machine.</span>

<span class="sd">    Args:</span>
<span class="sd">        states: Dictionary mapping state names to state instances</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If required states (Entry, Exit) are missing</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;Entry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">states</span> <span class="ow">or</span> <span class="s2">&quot;Exit&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;StateMachine requires Entry and Exit states&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">states</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;Entry&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;Entry&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exitState</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;Exit&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ethopy.core.experiment.StateMachine.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

<a href="#ethopy.core.experiment.StateMachine.run" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Execute the state machine until reaching exit state.</p>
<p>The machine will:
1. Check for state transition
2. Execute exit hook of current state if transitioning
3. Execute entry hook of new state if transitioning
4. Execute the current state's main logic
5. Determine next state</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="KeyError">KeyError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a state requests transition to non-existent state</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a state's next() method raises an exception</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ethopy/core/experiment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the state machine until reaching exit state.</span>

<span class="sd">    The machine will:</span>
<span class="sd">    1. Check for state transition</span>
<span class="sd">    2. Execute exit hook of current state if transitioning</span>
<span class="sd">    3. Execute entry hook of new state if transitioning</span>
<span class="sd">    4. Execute the current state&#39;s main logic</span>
<span class="sd">    5. Determine next state</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If a state requests transition to non-existent state</span>
<span class="sd">        RuntimeError: If a state&#39;s next() method raises an exception</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitState</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">entry</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

            <span class="n">next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">next_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid state transition to: </span><span class="si">{</span><span class="n">next_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">next_state</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exitState</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;State machine error in state</span>
<span class="s2">                </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                

              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.path", "search.highlight", "search.share", "search.suggest", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>