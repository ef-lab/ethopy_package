
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Python Boilerplate contains all the boilerplate you need to create a Python package.">
      
      
        <meta name="author" content="olakiril, alexevag">
      
      
        <link rel="canonical" href="https://ef-lab.github.io/ethopy_package/experiment/">
      
      
        <link rel="prev" href="../behavior/">
      
      
        <link rel="next" href="../interface/">
      
      
      <link rel="icon" href="../assets/LabPageBrain.gif">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.25">
    
    
      
        <title>Experiment module - EthoPy</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CRegular:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Google Sans";--md-code-font:"Regular"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#core-experiment-module" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="EthoPy" class="md-header__button md-logo" aria-label="EthoPy" data-md-component="logo">
      
  <img src="../assets/LabPageBrain.gif" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EthoPy
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Experiment module
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ef-lab/ethopy_package" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="EthoPy" class="md-nav__button md-logo" aria-label="EthoPy" data-md-component="logo">
      
  <img src="../assets/LabPageBrain.gif" alt="logo">

    </a>
    EthoPy
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ef-lab/ethopy_package" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../local_conf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Local congiguration
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../database/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Database Setup
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../task/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Task
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../plugin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Plugin System
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Changelog
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/ef-lab/ethopy_package/issues" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Report Issues
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../logger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logger module
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../behavior/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Behavior module
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Experiment module
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Experiment module
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment" class="md-nav__link">
    <span class="md-ellipsis">
      ethopy.core.experiment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Condition" class="md-nav__link">
    <span class="md-ellipsis">
      Condition
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Control" class="md-nav__link">
    <span class="md-ellipsis">
      Control
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass" class="md-nav__link">
    <span class="md-ellipsis">
      ExperimentClass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExperimentClass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.Block" class="md-nav__link">
    <span class="md-ellipsis">
      Block
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Block">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.Block.dict" class="md-nav__link">
    <span class="md-ellipsis">
      dict()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.add_performance_metric" class="md-nav__link">
    <span class="md-ellipsis">
      add_performance_metric()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.add_selection_method" class="md-nav__link">
    <span class="md-ellipsis">
      add_selection_method()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.get_keys_from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      get_keys_from_dict()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.is_stopped" class="md-nav__link">
    <span class="md-ellipsis">
      is_stopped()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.log_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      log_conditions()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.make_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      make_conditions()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.name" class="md-nav__link">
    <span class="md-ellipsis">
      name()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.prepare_trial" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_trial()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.push_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      push_conditions()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.setup" class="md-nav__link">
    <span class="md-ellipsis">
      setup()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.start" class="md-nav__link">
    <span class="md-ellipsis">
      start()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.stop" class="md-nav__link">
    <span class="md-ellipsis">
      stop()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.validate_condition" class="md-nav__link">
    <span class="md-ellipsis">
      validate_condition()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.MouseWeight" class="md-nav__link">
    <span class="md-ellipsis">
      MouseWeight
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Session" class="md-nav__link">
    <span class="md-ellipsis">
      Session
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Session">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Session.Excluded" class="md-nav__link">
    <span class="md-ellipsis">
      Excluded
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Session.Notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Session.Task" class="md-nav__link">
    <span class="md-ellipsis">
      Task
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State" class="md-nav__link">
    <span class="md-ellipsis">
      State
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.entry" class="md-nav__link">
    <span class="md-ellipsis">
      entry()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.exit" class="md-nav__link">
    <span class="md-ellipsis">
      exit()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.next" class="md-nav__link">
    <span class="md-ellipsis">
      next()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.run" class="md-nav__link">
    <span class="md-ellipsis">
      run()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.StateMachine" class="md-nav__link">
    <span class="md-ellipsis">
      StateMachine
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StateMachine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.StateMachine.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.StateMachine.run" class="md-nav__link">
    <span class="md-ellipsis">
      run()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Task" class="md-nav__link">
    <span class="md-ellipsis">
      Task
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Trial" class="md-nav__link">
    <span class="md-ellipsis">
      Trial
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Trial.Aborted" class="md-nav__link">
    <span class="md-ellipsis">
      Aborted
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Trial.StateOnset" class="md-nav__link">
    <span class="md-ellipsis">
      StateOnset
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../interface/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interface module
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stimulus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stimulus module
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment" class="md-nav__link">
    <span class="md-ellipsis">
      ethopy.core.experiment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Condition" class="md-nav__link">
    <span class="md-ellipsis">
      Condition
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Control" class="md-nav__link">
    <span class="md-ellipsis">
      Control
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass" class="md-nav__link">
    <span class="md-ellipsis">
      ExperimentClass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExperimentClass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.Block" class="md-nav__link">
    <span class="md-ellipsis">
      Block
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Block">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.Block.dict" class="md-nav__link">
    <span class="md-ellipsis">
      dict()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.add_performance_metric" class="md-nav__link">
    <span class="md-ellipsis">
      add_performance_metric()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.add_selection_method" class="md-nav__link">
    <span class="md-ellipsis">
      add_selection_method()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.get_keys_from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      get_keys_from_dict()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.is_stopped" class="md-nav__link">
    <span class="md-ellipsis">
      is_stopped()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.log_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      log_conditions()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.make_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      make_conditions()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.name" class="md-nav__link">
    <span class="md-ellipsis">
      name()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.prepare_trial" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_trial()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.push_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      push_conditions()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.setup" class="md-nav__link">
    <span class="md-ellipsis">
      setup()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.start" class="md-nav__link">
    <span class="md-ellipsis">
      start()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.stop" class="md-nav__link">
    <span class="md-ellipsis">
      stop()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.ExperimentClass.validate_condition" class="md-nav__link">
    <span class="md-ellipsis">
      validate_condition()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.MouseWeight" class="md-nav__link">
    <span class="md-ellipsis">
      MouseWeight
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Session" class="md-nav__link">
    <span class="md-ellipsis">
      Session
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Session">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Session.Excluded" class="md-nav__link">
    <span class="md-ellipsis">
      Excluded
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Session.Notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Session.Task" class="md-nav__link">
    <span class="md-ellipsis">
      Task
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State" class="md-nav__link">
    <span class="md-ellipsis">
      State
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.entry" class="md-nav__link">
    <span class="md-ellipsis">
      entry()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.exit" class="md-nav__link">
    <span class="md-ellipsis">
      exit()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.next" class="md-nav__link">
    <span class="md-ellipsis">
      next()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.State.run" class="md-nav__link">
    <span class="md-ellipsis">
      run()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.StateMachine" class="md-nav__link">
    <span class="md-ellipsis">
      StateMachine
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StateMachine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.StateMachine.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.StateMachine.run" class="md-nav__link">
    <span class="md-ellipsis">
      run()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Task" class="md-nav__link">
    <span class="md-ellipsis">
      Task
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Trial" class="md-nav__link">
    <span class="md-ellipsis">
      Trial
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Trial.Aborted" class="md-nav__link">
    <span class="md-ellipsis">
      Aborted
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ethopy.core.experiment.Trial.StateOnset" class="md-nav__link">
    <span class="md-ellipsis">
      StateOnset
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                



                  

  
  


<h1 id="core-experiment-module">Core Experiment module<a class="headerlink" href="#core-experiment-module" title="Permanent link">&para;</a></h1>


  <div class="doc doc-object doc-module">

<a id="ethopy.core.experiment"></a>
    <div class="doc doc-contents first">

      <p>Core experiment module for experiment control.</p>
<p>This module provides the base classes and functionality for running behavioral
experiments. It includes:
- State machine implementation for experiment flow control
- Condition management and randomization
- Trial preparation and execution
- Performance tracking and analysis</p>
<p>The module is built around three main classes:
- State: Base class for implementing experiment states
- StateMachine: Control the flow of the experiment
- ExperimentClass: Base class for experiment implementation</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h2 id="ethopy.core.experiment.Condition" class="doc doc-heading">
        <code>
Condition            (<span title="datajoint.user_tables.Manual">Manual</span>)
        </code>



<a href="#ethopy.core.experiment.Condition" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Table definition:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code># unique stimulus conditions
cond_hash             : char(24)                 # unique condition hash
---
stimulus_class        : varchar(128)
behavior_class        : varchar(128)
experiment_class      : varchar(128)
</code></pre></div></td></tr></table></div>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Condition</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # unique stimulus conditions</span>
<span class="s2">    cond_hash             : char(24)                 # unique condition hash</span>
<span class="s2">    ---</span>
<span class="s2">    stimulus_class        : varchar(128)</span>
<span class="s2">    behavior_class        : varchar(128)</span>
<span class="s2">    experiment_class      : varchar(128)</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 id="ethopy.core.experiment.Control" class="doc doc-heading">
        <code>
Control            (<span title="datajoint.user_tables.Lookup">Lookup</span>)
        </code>



<a href="#ethopy.core.experiment.Control" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Table definition:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code># Control table
setup                       : varchar(256)                 # Setup name
---
status=&quot;exit&quot;               : enum(&#39;ready&#39;,
                                    &#39;running&#39;,
                                    &#39;stop&#39;,
                                    &#39;sleeping&#39;,
                                    &#39;exit&#39;,
                                    &#39;offtime&#39;,
                                    &#39;wakeup&#39;)
animal_id=0                 : int                       # animal id
task_idx=0                  : int                       # task identification number
session=0                   : int
trials=0                    : int
total_liquid=0              : float
state=&#39;none&#39;                : varchar(255)
difficulty=0                : smallint
start_time=&#39;00:00:00&#39;       : time
stop_time=&#39;23:59:00&#39;        : time
last_ping=CURRENT_TIMESTAMP : timestamp
notes=&#39;&#39;                    : varchar(256)
queue_size=0                : int
ip=null                     : varchar(16)                  # setup IP address
</code></pre></div></td></tr></table></div>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Control</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Lookup</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Control table</span>
<span class="s2">    setup                       : varchar(256)                 # Setup name</span>
<span class="s2">    ---</span>
<span class="s2">    status=&quot;exit&quot;               : enum(&#39;ready&#39;,</span>
<span class="s2">                                        &#39;running&#39;,</span>
<span class="s2">                                        &#39;stop&#39;,</span>
<span class="s2">                                        &#39;sleeping&#39;,</span>
<span class="s2">                                        &#39;exit&#39;,</span>
<span class="s2">                                        &#39;offtime&#39;,</span>
<span class="s2">                                        &#39;wakeup&#39;)</span>
<span class="s2">    animal_id=0                 : int                       # animal id</span>
<span class="s2">    task_idx=0                  : int                       # task identification number</span>
<span class="s2">    session=0                   : int</span>
<span class="s2">    trials=0                    : int</span>
<span class="s2">    total_liquid=0              : float</span>
<span class="s2">    state=&#39;none&#39;                : varchar(255)</span>
<span class="s2">    difficulty=0                : smallint</span>
<span class="s2">    start_time=&#39;00:00:00&#39;       : time</span>
<span class="s2">    stop_time=&#39;23:59:00&#39;        : time</span>
<span class="s2">    last_ping=CURRENT_TIMESTAMP : timestamp</span>
<span class="s2">    notes=&#39;&#39;                    : varchar(256)</span>
<span class="s2">    queue_size=0                : int</span>
<span class="s2">    ip=null                     : varchar(16)                  # setup IP address</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 id="ethopy.core.experiment.ExperimentClass" class="doc doc-heading">
        <code>
ExperimentClass        </code>



<a href="#ethopy.core.experiment.ExperimentClass" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Parent Experiment.</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ExperimentClass</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parent Experiment.&quot;&quot;&quot;</span>

    <span class="n">curr_trial</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the current trial number in the session</span>
    <span class="n">cur_block</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the current block number in the session</span>
    <span class="n">states</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dictionary wiht all states of the experiment</span>
    <span class="n">stims</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dictionary with all stimulus classes</span>
    <span class="n">stim</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># the current condition stimulus class</span>
    <span class="n">sync</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># a boolean to make synchronization available</span>
    <span class="n">un_choices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">curr_cond</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">block_h</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">has_responded</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">resp_ready</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">default_key</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cond_tables</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">quit</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">cur_block_sz</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">setup_conf_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">beh</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">trial_start</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># time in ms of the trial start</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">behavior_class</span><span class="p">,</span> <span class="n">session_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up Experiment.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_h</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stims</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_block_sz</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span> <span class="o">=</span> <span class="n">session_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">session_params</span><span class="p">[</span><span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_key</span><span class="p">,</span> <span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh</span> <span class="o">=</span> <span class="n">behavior_class</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interface_setup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">load_calibration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_session</span><span class="p">(</span>
            <span class="n">session_params</span><span class="p">,</span> <span class="n">experiment_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cond_tables</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">log_task</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>

        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># fix random seed, it can be overidden in the task file</span>

    <span class="k">def</span> <span class="nf">_interface_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beh</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">setup_conf_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Interface</span><span class="p">:</span>
        <span class="n">interface_module</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;interface&quot;</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="s2">&quot;SetupConfiguration&quot;</span><span class="p">,</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;interface&quot;</span><span class="p">],</span>
            <span class="n">key</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">:</span> <span class="n">setup_conf_idx</span><span class="p">},</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interface: </span><span class="si">{</span><span class="n">interface_module</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">interface</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">import_module</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ethopy.interfaces.</span><span class="si">{</span><span class="n">interface_module</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">interface_module</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">interface</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">beh</span><span class="o">=</span><span class="n">beh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the StateMachine.&quot;&quot;&quot;</span>
        <span class="n">states</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">():</span>  <span class="c1"># Initialize states</span>
            <span class="n">states</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">state</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="n">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)})</span>
        <span class="n">state_control</span> <span class="o">=</span> <span class="n">StateMachine</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">set_operation_status</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">state_control</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the epxeriment.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">is_recording</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for recording to end...&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">closeDatasets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">is_stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check is experiment should stop.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setup_status</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setup_status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">update_setup_info</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;stop&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span>

    <span class="k">def</span> <span class="nf">_stim_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stim_class</span><span class="p">:</span> <span class="n">Stimulus</span><span class="p">,</span> <span class="n">stims</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="c1"># get stimulus class name</span>
        <span class="n">stim_name</span> <span class="o">=</span> <span class="n">stim_class</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">stim_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stims</span><span class="p">:</span>
            <span class="n">stim_class</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">stims</span><span class="p">[</span><span class="n">stim_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_class</span>
        <span class="k">return</span> <span class="n">stims</span>

    <span class="k">def</span> <span class="nf">get_keys_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Efficiently extract specific keys from a dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (dict): The input dictionary.</span>
<span class="sd">            keys (list): The list of keys to extract.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A new dictionary with only the specified keys if they exist.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>  <span class="c1"># Convert list to set for O(1) lookup</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">data</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">_get_task_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stim_class</span><span class="p">:</span> <span class="n">Stimulus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">exp_name</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;experiment_class&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond_tables</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="n">beh_name</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;behavior_class&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">cond_tables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond_tables</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
        <span class="n">stim_name</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">:</span> <span class="n">stim_class</span><span class="o">.</span><span class="n">name</span><span class="p">()}</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">exp_name</span><span class="p">,</span> <span class="o">**</span><span class="n">beh_name</span><span class="p">,</span> <span class="o">**</span><span class="n">stim_name</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">make_conditions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stim_class</span><span class="p">:</span> <span class="n">Stimulus</span><span class="p">,</span>
        <span class="n">conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">stim_periods</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create conditions by combining stimulus, behavior, and experiment.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;-------------- Make conditions --------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stim_init</span><span class="p">(</span><span class="n">stim_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">)</span>
        <span class="n">used_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># all the keys used from dictionary conditions</span>

        <span class="c1"># Handle stimulus conditions</span>
        <span class="n">stim_conditions</span><span class="p">,</span> <span class="n">stim_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_stim_conditions</span><span class="p">(</span>
            <span class="n">stim_class</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">stim_periods</span>
        <span class="p">)</span>
        <span class="n">used_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stim_keys</span><span class="p">)</span>

        <span class="c1"># Process behavior conditions</span>
        <span class="n">beh_conditions</span><span class="p">,</span> <span class="n">beh_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_behavior_conditions</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
        <span class="n">used_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beh_keys</span><span class="p">)</span>

        <span class="c1"># Process experiment conditions</span>
        <span class="n">exp_conditions</span><span class="p">,</span> <span class="n">exp_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_experiment_conditions</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_task_classes</span><span class="p">(</span><span class="n">stim_class</span><span class="p">),</span> <span class="n">conditions</span>
        <span class="p">)</span>
        <span class="n">used_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">exp_keys</span><span class="p">)</span>

        <span class="c1"># Combine results and handle unused parameters</span>
        <span class="n">partial_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_conditions</span><span class="p">,</span> <span class="n">beh_conditions</span><span class="p">,</span> <span class="n">stim_conditions</span><span class="p">]</span>
        <span class="n">unused_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_unused_parameters</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">used_keys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unused_conditions</span><span class="p">:</span>
            <span class="n">partial_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unused_conditions</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;-----------------------------------------------&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">comb</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">partial_results</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_process_stim_conditions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">stim_class</span><span class="p">:</span> <span class="n">Stimulus</span><span class="p">,</span> <span class="n">conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">stim_periods</span><span class="p">:</span> <span class="n">List</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process stimulus-specific conditions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stim_periods</span><span class="p">:</span>
            <span class="n">period_conditions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">stim_periods</span><span class="p">:</span>
                <span class="n">stim_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys_from_dict</span><span class="p">(</span>
                    <span class="n">conditions</span><span class="p">[</span><span class="n">period</span><span class="p">],</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">stim_class</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Stimulus period: </span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s2"> use default conditions:&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">stim_class</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">stim_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">period_conditions</span><span class="p">[</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">(</span><span class="n">stim_dict</span><span class="p">)</span>
                <span class="n">period_conditions</span><span class="p">[</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">[</span>
                    <span class="n">stim_class</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                <span class="p">]</span><span class="o">.</span><span class="n">make_conditions</span><span class="p">(</span><span class="n">period_conditions</span><span class="p">[</span><span class="n">period</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stim_condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">period_conditions</span><span class="p">[</span><span class="n">period</span><span class="p">]):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Stimulus condition </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">format_params_print</span><span class="p">(</span><span class="n">stim_condition</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="n">stim_conditions</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">(</span><span class="n">period_conditions</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stim_conditions</span><span class="p">,</span> <span class="n">stim_periods</span>

        <span class="n">stim_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys_from_dict</span><span class="p">(</span>
            <span class="n">conditions</span><span class="p">,</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">stim_class</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Stimulus use default conditions:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">stim_class</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">stim_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">stim_conditions</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">(</span><span class="n">stim_dict</span><span class="p">)</span>
        <span class="n">stim_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">[</span><span class="n">stim_class</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span><span class="o">.</span><span class="n">make_conditions</span><span class="p">(</span><span class="n">stim_conditions</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stim_condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stim_conditions</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stimulus condition </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">format_params_print</span><span class="p">(</span><span class="n">stim_condition</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stim_conditions</span><span class="p">,</span> <span class="n">stim_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_process_behavior_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process behavior-related conditions.&quot;&quot;&quot;</span>
        <span class="n">beh_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys_from_dict</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Behavior use default conditions:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">beh_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">beh_conditions</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">(</span><span class="n">beh_dict</span><span class="p">)</span>
        <span class="n">beh_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">make_conditions</span><span class="p">(</span><span class="n">beh_conditions</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">beh_condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">beh_conditions</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Behavior condition </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">format_params_print</span><span class="p">(</span><span class="n">beh_condition</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">beh_conditions</span><span class="p">,</span> <span class="n">beh_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_process_experiment_conditions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">task_classes</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">conditions</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process experiment-wide conditions.&quot;&quot;&quot;</span>
        <span class="n">exp_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys_from_dict</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">exp_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">task_classes</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Experiment use default conditions:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">exp_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">exp_conditions</span> <span class="o">=</span> <span class="n">factorize</span><span class="p">(</span><span class="n">exp_dict</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">exp_conditions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_condition</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
            <span class="n">cond</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_key</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">cond</span><span class="p">})</span>
        <span class="n">cond_tables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Condition.&quot;</span> <span class="o">+</span> <span class="n">table</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond_tables</span><span class="p">]</span>
        <span class="n">conditions_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_conditions</span><span class="p">(</span>
            <span class="n">exp_conditions</span><span class="p">,</span> <span class="n">condition_tables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Condition&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cond_tables</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exp_condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exp_conditions</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Experiment condition </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">format_params_print</span><span class="p">(</span><span class="n">exp_condition</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">conditions_list</span><span class="p">,</span> <span class="n">exp_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_handle_unused_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">used_keys</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process any unused parameters.&quot;&quot;&quot;</span>
        <span class="n">unused_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">conditions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">used_keys</span>
        <span class="k">if</span> <span class="n">unused_keys</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Keys: </span><span class="si">{</span><span class="n">unused_keys</span><span class="si">}</span><span class="s2"> are in condition but are not used from&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Experiment, Behavior or Stimulus&quot;</span>
            <span class="p">)</span>
            <span class="n">unused_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys_from_dict</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">unused_keys</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">factorize</span><span class="p">(</span><span class="n">unused_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">validate_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate a condition dictionary against the required fields.</span>

<span class="sd">        Args:</span>
<span class="sd">            condition (Dict): The condition dictionary to validate.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If required fields are missing from the condition.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">missing_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_fields</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing experiment required fields: </span><span class="si">{</span><span class="n">missing_fields</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">push_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the experimental conditions and initializes related data structures.</span>

<span class="sd">        This method takes a list of condition dictionaries, prepares data structures</span>
<span class="sd">        for tracking choices, blocks, and the current condition.  It also determines</span>
<span class="sd">        unique choice hashes based on the response condition and difficulty.</span>

<span class="sd">        Args:</span>
<span class="sd">            conditions: A list of dictionaries, where each dictionary</span>
<span class="sd">                represents an experimental condition.  Each condition</span>
<span class="sd">                dictionary is expected to contain at least a &quot;difficulty&quot;</span>
<span class="sd">                key.  If a `resp_cond` key (or the default &quot;response_port&quot;)</span>
<span class="sd">                is present, it&#39;s used to create unique choice hashes.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of conditions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="n">conditions</span>
        <span class="n">resp_cond</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;resp_cond&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;resp_cond&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">else</span> <span class="s2">&quot;response_port&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;difficulty&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">resp_cond</span> <span class="ow">in</span> <span class="n">cond</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">make_hash</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="n">resp_cond</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;difficulty&quot;</span><span class="p">]])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">un_choices</span><span class="p">,</span> <span class="n">un_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">un_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">un_idx</span><span class="p">]</span>
        <span class="c1">#  select random condition for first trial initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare trial conditions, stimuli and update trial index.&quot;&quot;&quot;</span>
        <span class="n">old_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_new_cond</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">thread_end</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;stimulus_class&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_cond</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">or</span> <span class="n">old_cond</span><span class="p">[</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;stimulus_class&quot;</span> <span class="ow">in</span> <span class="n">old_cond</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">]]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;setting up stimulus&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;stimuli is done&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">update_trial_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trial_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger_timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="s2">&quot;Trial&quot;</span><span class="p">,</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">cond_hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;cond_hash&quot;</span><span class="p">],</span> <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_start</span><span class="p">),</span>
            <span class="n">priority</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Name of experiment class.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">def</span> <span class="nf">_make_cond_hash</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
        <span class="n">hash_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">:</span> <span class="n">dj</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
        <span class="n">condition_tables</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make unique hash based on all fields from condition tables.&quot;&quot;&quot;</span>
        <span class="c1"># get all fields from condition tables except hash</span>
        <span class="n">fields_key</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span>
            <span class="k">for</span> <span class="n">ctable</span> <span class="ow">in</span> <span class="n">condition_tables</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">get_table_keys</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ctable</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">fields_key</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">hash_field</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
            <span class="c1"># find all dependant fields and generate hash</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fields_key</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">condition</span><span class="p">}</span>
            <span class="n">condition</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">hash_field</span><span class="p">:</span> <span class="n">make_hash</span><span class="p">(</span><span class="n">key</span><span class="p">)})</span>
        <span class="k">return</span> <span class="n">conditions</span>

    <span class="k">def</span> <span class="nf">log_conditions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">conditions</span><span class="p">,</span>
        <span class="n">condition_tables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;experiment&quot;</span><span class="p">,</span>
        <span class="n">hash_field</span><span class="o">=</span><span class="s2">&quot;cond_hash&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log experimental conditions to specified tables with hashes tracking.</span>

<span class="sd">        Args:</span>
<span class="sd">            conditions (List): List of condition dictionaries to log</span>
<span class="sd">            condition_tables (List): List of table names to log to</span>
<span class="sd">            schema (db.shcema): Database schema name</span>
<span class="sd">            hash_field (str): Name of the hash field</span>
<span class="sd">            priority (int): for the insertion order of the logger</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of processed conditions with added hashes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">conditions</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">condition_tables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">condition_tables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Condition&quot;</span><span class="p">]</span>

        <span class="n">conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_cond_hash</span><span class="p">(</span>
            <span class="n">conditions</span><span class="p">,</span> <span class="n">hash_field</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">condition_tables</span>
        <span class="p">)</span>

        <span class="n">processed_conditions</span> <span class="o">=</span> <span class="n">conditions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">processed_conditions</span><span class="p">:</span>
            <span class="c1"># insert conditions fields to the correspond table</span>
            <span class="k">for</span> <span class="n">ctable</span> <span class="ow">in</span> <span class="n">condition_tables</span><span class="p">:</span>
                <span class="c1"># Get table metadata</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">get_table_keys</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ctable</span><span class="p">))</span>
                <span class="n">primary_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">get_table_keys</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ctable</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">core</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">primary_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">hash_field</span><span class="p">]</span>

                <span class="c1"># Validate condition has all required fields</span>
                <span class="n">missing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">condition</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">ctable</span><span class="si">}</span><span class="s2">, Missing keys:</span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># check if there is a primary key which is not hash and it is iterable</span>
                <span class="k">if</span> <span class="n">core</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="n">core</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                    <span class="c1"># TODO make a function for this and clarify it</span>
                    <span class="c1"># If any of the primary keys is iterable all the rest should be.</span>
                    <span class="c1"># The first element of the iterable will be matched with the first</span>
                    <span class="c1"># element of the rest of the keys</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="n">core</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
                        <span class="n">cond_key</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                                <span class="n">cond_key</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">cond_key</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                            <span class="n">table</span><span class="o">=</span><span class="n">ctable</span><span class="p">,</span>
                            <span class="nb">tuple</span><span class="o">=</span><span class="n">cond_key</span><span class="p">,</span>
                            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                            <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                        <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                        <span class="n">table</span><span class="o">=</span><span class="n">ctable</span><span class="p">,</span> <span class="nb">tuple</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">priority</span>
                    <span class="p">)</span>

                <span class="c1"># Increment the priority for each subsequent table</span>
                <span class="c1"># to ensure they are inserted in the correct order</span>
                <span class="n">priority</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">processed_conditions</span>

    <span class="k">def</span> <span class="nf">_anti_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">choice_h</span><span class="p">,</span> <span class="n">un_choices</span><span class="p">):</span>
        <span class="n">choice_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">make_hash</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">choice_h</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;bias_window&quot;</span><span class="p">]</span> <span class="p">:]]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choice_h</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;bias_window&quot;</span><span class="p">]:</span>
            <span class="n">choice_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choices</span>
        <span class="n">fixed_p</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">choice_h</span> <span class="o">==</span> <span class="n">un</span><span class="p">)</span> <span class="k">for</span> <span class="n">un</span> <span class="ow">in</span> <span class="n">un_choices</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fixed_p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fixed_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fixed_p</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">un_choices</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">fixed_p</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fixed_p</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_new_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get next condition based on trial selection method.&quot;&quot;&quot;</span>
        <span class="n">selection_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;trial_selection&quot;</span><span class="p">]</span>
        <span class="n">selection_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;fixed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_selection</span><span class="p">,</span>
            <span class="s2">&quot;block&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_selection</span><span class="p">,</span>
            <span class="s2">&quot;random&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_selection</span><span class="p">,</span>
            <span class="s2">&quot;staircase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staircase_selection</span><span class="p">,</span>
            <span class="s2">&quot;biased&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_biased_selection</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">handler</span> <span class="o">=</span> <span class="n">selection_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">selection_method</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="o">=</span> <span class="n">handler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selection method &#39;</span><span class="si">{</span><span class="n">selection_method</span><span class="si">}</span><span class="s2">&#39; not implemented!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_fixed_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select next condition by popping from ordered list.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_block_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select random condition from a block.</span>

<span class="sd">        Select a condition from a block of conditions until all</span>
<span class="sd">        conditions has been selected, then repeat them randomnly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">))</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">cond</span>

    <span class="k">def</span> <span class="nf">_random_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select random condition from available conditions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_block_difficulty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perf</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update block difficulty based on performance.</span>

<span class="sd">        Args:</span>
<span class="sd">            perf: Current performance metric</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block_sz</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;staircase_window&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">perf</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;stair_up&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;next_up&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_block_sz</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">update_setup_info</span><span class="p">({</span><span class="s2">&quot;difficulty&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">perf</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;stair_down&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;next_down&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_block_sz</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">update_setup_info</span><span class="p">({</span><span class="s2">&quot;difficulty&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_get_valid_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition_idx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get list of valid conditions based on condition index.</span>

<span class="sd">        Args:</span>
<span class="sd">            condition_idx: Boolean array indicating valid conditions</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of valid condition dictionaries</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">,</span> <span class="n">condition_idx</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_staircase_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select next condition using staircase method.&quot;&quot;&quot;</span>
        <span class="c1"># Get performance metrics</span>
        <span class="n">perf</span><span class="p">,</span> <span class="n">choice_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_performance</span><span class="p">()</span>

        <span class="c1"># Update block size if there was a choice in last trial</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">choice_history</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">choice_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur_block_sz</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Update difficulty if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_block_difficulty</span><span class="p">(</span><span class="n">perf</span><span class="p">)</span>

        <span class="c1"># Select condition based on current block and anti-bias</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;antibias&quot;</span><span class="p">]:</span>
            <span class="n">valid_choices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">un_choices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">un_blocks</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span><span class="p">]</span>
            <span class="n">anti_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anti_bias</span><span class="p">(</span><span class="n">choice_h</span><span class="p">,</span> <span class="n">valid_choices</span><span class="p">)</span>
            <span class="n">condition_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">==</span> <span class="n">anti_bias</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">condition_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span>

        <span class="n">valid_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_valid_conditions</span><span class="p">(</span><span class="n">condition_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_conditions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_biased_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select next condition using anti-bias method.&quot;&quot;&quot;</span>
        <span class="n">perf</span><span class="p">,</span> <span class="n">choice_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_performance</span><span class="p">()</span>
        <span class="n">anti_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anti_bias</span><span class="p">(</span><span class="n">choice_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">un_choices</span><span class="p">)</span>
        <span class="n">condition_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">==</span> <span class="n">anti_bias</span>
        <span class="n">valid_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_valid_conditions</span><span class="p">(</span><span class="n">condition_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_conditions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_selection_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new trial selection method.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Name of the selection method</span>
<span class="sd">            handler: Function that returns next condition</span>

<span class="sd">        Example:</span>
<span class="sd">            def my_selection_method(self):</span>
<span class="sd">                # Custom selection logic</span>
<span class="sd">                return selected_condition</span>

<span class="sd">            experiment.add_selection_method(&#39;custom&#39;, my_selection_method)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_selection&quot;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_selection&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added new selection method: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selection method &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already exists&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate performance metrics based on trial history.&quot;&quot;&quot;</span>
        <span class="n">rewards</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_valid_trial_data</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rewards</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>  <span class="c1"># Check if there are any valid trials</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="p">[]</span>

        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;staircase_window&quot;</span><span class="p">]</span>
        <span class="n">recent_rewards</span> <span class="o">=</span> <span class="n">rewards</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:]</span>
        <span class="n">recent_choices</span> <span class="o">=</span> <span class="n">choices</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:]</span>
        <span class="n">recent_blocks</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:]</span> <span class="k">if</span> <span class="n">blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metric</span><span class="p">(</span>
            <span class="n">recent_rewards</span><span class="p">,</span> <span class="n">recent_choices</span><span class="p">,</span> <span class="n">recent_blocks</span>
        <span class="p">)</span>

        <span class="n">choice_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_choice_history</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="n">blocks</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">staircase_window: </span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;rewards: </span><span class="si">{</span><span class="n">recent_rewards</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;choices: </span><span class="si">{</span><span class="n">recent_choices</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;blocks: </span><span class="si">{</span><span class="n">recent_blocks</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;performace: </span><span class="si">{</span><span class="n">performance</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">performance</span><span class="p">,</span> <span class="n">choice_history</span>

    <span class="k">def</span> <span class="nf">_extract_valid_trial_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract trials that are either punish or reward.</span>

<span class="sd">        rewards: reward amount given at trials that have been rewarded else nan</span>
<span class="sd">        choices: selected port in reward &amp; punish trials</span>
<span class="sd">        blocks: block index in each trial that is reward or punish</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
            <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">reward_history</span><span class="p">),</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">punish_history</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">rewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">reward_history</span><span class="p">)[</span><span class="n">valid_idx</span><span class="p">]</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">choice_history</span><span class="p">)[</span><span class="n">valid_idx</span><span class="p">])</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_h</span><span class="p">)[</span><span class="n">valid_idx</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_h</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">blocks</span>

    <span class="k">def</span> <span class="nf">_calculate_accuracy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">rewards</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate accuracy from trial data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_calculate_dprime</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">rewards</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate d-prime from trial data.&quot;&quot;&quot;</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">c</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="n">rewards</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_true</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">def</span> <span class="nf">_calculate_metric</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">rewards</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate performance metric specified in current condition.&quot;&quot;&quot;</span>
        <span class="n">metric_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_accuracy</span><span class="p">,</span>
            <span class="s2">&quot;dprime&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_dprime</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">handler</span> <span class="o">=</span> <span class="n">metric_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">blocks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Performance metric &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; not implemented!&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">def</span> <span class="nf">_get_choice_history</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create choice history with difficulty levels.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[[</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="n">blocks</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">add_performance_metric</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span> <span class="nb">float</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new performance metric calculation method.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Name of the metric</span>
<span class="sd">            handler: Function that takes ValidTrials and returns performance score</span>

<span class="sd">        Example:</span>
<span class="sd">            def calculate_custom_metric(trials):</span>
<span class="sd">                # Custom metric calculation</span>
<span class="sd">                return score</span>

<span class="sd">            experiment.add_performance_metric(&#39;custom&#39;, calculate_custom_metric)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added new performance metric: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance metric &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already exists&quot;</span><span class="p">)</span>

    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">Block</span><span class="p">:</span>
        <span class="n">difficulty</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">stair_up</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">stair_down</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.55</span><span class="p">)</span>
        <span class="n">next_up</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">next_down</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">staircase_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">bias_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">trial_selection</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;fixed&quot;</span><span class="p">)</span>
        <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
        <span class="n">antibias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">noresponse_intertrial</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">incremental_punishment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Rerurn parameters as dictionary.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">

































  <div class="doc doc-object doc-class">



<h3 id="ethopy.core.experiment.ExperimentClass.Block" class="doc doc-heading">
        <code>
Block        </code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-dataclass"><code>dataclass</code></small>
  </span>

<a href="#ethopy.core.experiment.ExperimentClass.Block" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Block(difficulty: int = 0, stair_up: float = 0.7, stair_down: float = 0.55, next_up: int = 0, next_down: int = 0, staircase_window: int = 20, bias_window: int = 5, trial_selection: str = 'fixed', metric: str = 'accuracy', antibias: bool = True, noresponse_intertrial: bool = True, incremental_punishment: bool = False)</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Block</span><span class="p">:</span>
    <span class="n">difficulty</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">stair_up</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">stair_down</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.55</span><span class="p">)</span>
    <span class="n">next_up</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">next_down</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">staircase_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">bias_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">trial_selection</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;fixed&quot;</span><span class="p">)</span>
    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
    <span class="n">antibias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">noresponse_intertrial</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">incremental_punishment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rerurn parameters as dictionary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">
























  <div class="doc doc-object doc-method">



<h4 id="ethopy.core.experiment.ExperimentClass.Block.dict" class="doc doc-heading">
<code class="highlight language-python"><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.Block.dict" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Rerurn parameters as dictionary.</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rerurn parameters as dictionary.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>





  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.ExperimentClass.add_performance_metric" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_performance_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.add_performance_metric" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Add a new performance metric calculation method.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>name</code></td>
        <td><code>str</code></td>
        <td><p>Name of the metric</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>handler</code></td>
        <td><code>Callable[[numpy.ndarray, numpy.ndarray, Optional[numpy.ndarray]], float]</code></td>
        <td><p>Function that takes ValidTrials and returns performance score</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <p>def calculate_custom_metric(trials):
    # Custom metric calculation
    return score</p>
<p>experiment.add_performance_metric('custom', calculate_custom_metric)</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">add_performance_metric</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span> <span class="nb">float</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new performance metric calculation method.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Name of the metric</span>
<span class="sd">        handler: Function that takes ValidTrials and returns performance score</span>

<span class="sd">    Example:</span>
<span class="sd">        def calculate_custom_metric(trials):</span>
<span class="sd">            # Custom metric calculation</span>
<span class="sd">            return score</span>

<span class="sd">        experiment.add_performance_metric(&#39;custom&#39;, calculate_custom_metric)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added new performance metric: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance metric &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already exists&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.ExperimentClass.add_selection_method" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_selection_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.add_selection_method" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Add a new trial selection method.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>name</code></td>
        <td><code>str</code></td>
        <td><p>Name of the selection method</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>handler</code></td>
        <td><code>Callable[[], Dict]</code></td>
        <td><p>Function that returns next condition</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <p>def my_selection_method(self):
    # Custom selection logic
    return selected_condition</p>
<p>experiment.add_selection_method('custom', my_selection_method)</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">add_selection_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new trial selection method.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Name of the selection method</span>
<span class="sd">        handler: Function that returns next condition</span>

<span class="sd">    Example:</span>
<span class="sd">        def my_selection_method(self):</span>
<span class="sd">            # Custom selection logic</span>
<span class="sd">            return selected_condition</span>

<span class="sd">        experiment.add_selection_method(&#39;custom&#39;, my_selection_method)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_selection&quot;</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_selection&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added new selection method: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selection method &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already exists&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.ExperimentClass.get_keys_from_dict" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_keys_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.get_keys_from_dict" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Efficiently extract specific keys from a dictionary.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>data</code></td>
        <td><code>dict</code></td>
        <td><p>The input dictionary.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>keys</code></td>
        <td><code>list</code></td>
        <td><p>The list of keys to extract.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>dict</code></td>
      <td><p>A new dictionary with only the specified keys if they exist.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_keys_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Efficiently extract specific keys from a dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (dict): The input dictionary.</span>
<span class="sd">        keys (list): The list of keys to extract.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A new dictionary with only the specified keys if they exist.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>  <span class="c1"># Convert list to set for O(1) lookup</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">data</span><span class="p">)}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.ExperimentClass.is_stopped" class="doc doc-heading">
<code class="highlight language-python"><span class="n">is_stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.is_stopped" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Check is experiment should stop.</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">is_stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check is experiment should stop.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setup_status</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setup_status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">update_setup_info</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;stop&quot;</span><span class="p">})</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.ExperimentClass.log_conditions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">log_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">condition_tables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="n">hash_field</span><span class="o">=</span><span class="s1">&#39;cond_hash&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.log_conditions" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Log experimental conditions to specified tables with hashes tracking.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>conditions</code></td>
        <td><code>List</code></td>
        <td><p>List of condition dictionaries to log</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>condition_tables</code></td>
        <td><code>List</code></td>
        <td><p>List of table names to log to</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>schema</code></td>
        <td><code>db.shcema</code></td>
        <td><p>Database schema name</p></td>
        <td><code>&#39;experiment&#39;</code></td>
      </tr>
      <tr>
        <td><code>hash_field</code></td>
        <td><code>str</code></td>
        <td><p>Name of the hash field</p></td>
        <td><code>&#39;cond_hash&#39;</code></td>
      </tr>
      <tr>
        <td><code>priority</code></td>
        <td><code>int</code></td>
        <td><p>for the insertion order of the logger</p></td>
        <td><code>2</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[Dict]</code></td>
      <td><p>List of processed conditions with added hashes</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">log_conditions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">conditions</span><span class="p">,</span>
    <span class="n">condition_tables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;experiment&quot;</span><span class="p">,</span>
    <span class="n">hash_field</span><span class="o">=</span><span class="s2">&quot;cond_hash&quot;</span><span class="p">,</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log experimental conditions to specified tables with hashes tracking.</span>

<span class="sd">    Args:</span>
<span class="sd">        conditions (List): List of condition dictionaries to log</span>
<span class="sd">        condition_tables (List): List of table names to log to</span>
<span class="sd">        schema (db.shcema): Database schema name</span>
<span class="sd">        hash_field (str): Name of the hash field</span>
<span class="sd">        priority (int): for the insertion order of the logger</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of processed conditions with added hashes</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">conditions</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">condition_tables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">condition_tables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Condition&quot;</span><span class="p">]</span>

    <span class="n">conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_cond_hash</span><span class="p">(</span>
        <span class="n">conditions</span><span class="p">,</span> <span class="n">hash_field</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">condition_tables</span>
    <span class="p">)</span>

    <span class="n">processed_conditions</span> <span class="o">=</span> <span class="n">conditions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">processed_conditions</span><span class="p">:</span>
        <span class="c1"># insert conditions fields to the correspond table</span>
        <span class="k">for</span> <span class="n">ctable</span> <span class="ow">in</span> <span class="n">condition_tables</span><span class="p">:</span>
            <span class="c1"># Get table metadata</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">get_table_keys</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ctable</span><span class="p">))</span>
            <span class="n">primary_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">get_table_keys</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">ctable</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">core</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">primary_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">hash_field</span><span class="p">]</span>

            <span class="c1"># Validate condition has all required fields</span>
            <span class="n">missing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">condition</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">ctable</span><span class="si">}</span><span class="s2">, Missing keys:</span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># check if there is a primary key which is not hash and it is iterable</span>
            <span class="k">if</span> <span class="n">core</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="n">core</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                <span class="c1"># TODO make a function for this and clarify it</span>
                <span class="c1"># If any of the primary keys is iterable all the rest should be.</span>
                <span class="c1"># The first element of the iterable will be matched with the first</span>
                <span class="c1"># element of the rest of the keys</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="n">core</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
                    <span class="n">cond_key</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                            <span class="n">cond_key</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cond_key</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                        <span class="n">table</span><span class="o">=</span><span class="n">ctable</span><span class="p">,</span>
                        <span class="nb">tuple</span><span class="o">=</span><span class="n">cond_key</span><span class="p">,</span>
                        <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                        <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                    <span class="n">table</span><span class="o">=</span><span class="n">ctable</span><span class="p">,</span> <span class="nb">tuple</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">priority</span>
                <span class="p">)</span>

            <span class="c1"># Increment the priority for each subsequent table</span>
            <span class="c1"># to ensure they are inserted in the correct order</span>
            <span class="n">priority</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">processed_conditions</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.ExperimentClass.make_conditions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stim_class</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">stim_periods</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.make_conditions" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Create conditions by combining stimulus, behavior, and experiment.</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">make_conditions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">stim_class</span><span class="p">:</span> <span class="n">Stimulus</span><span class="p">,</span>
    <span class="n">conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">stim_periods</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create conditions by combining stimulus, behavior, and experiment.&quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;-------------- Make conditions --------------&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stim_init</span><span class="p">(</span><span class="n">stim_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">)</span>
    <span class="n">used_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># all the keys used from dictionary conditions</span>

    <span class="c1"># Handle stimulus conditions</span>
    <span class="n">stim_conditions</span><span class="p">,</span> <span class="n">stim_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_stim_conditions</span><span class="p">(</span>
        <span class="n">stim_class</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">stim_periods</span>
    <span class="p">)</span>
    <span class="n">used_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stim_keys</span><span class="p">)</span>

    <span class="c1"># Process behavior conditions</span>
    <span class="n">beh_conditions</span><span class="p">,</span> <span class="n">beh_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_behavior_conditions</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
    <span class="n">used_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beh_keys</span><span class="p">)</span>

    <span class="c1"># Process experiment conditions</span>
    <span class="n">exp_conditions</span><span class="p">,</span> <span class="n">exp_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_experiment_conditions</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_task_classes</span><span class="p">(</span><span class="n">stim_class</span><span class="p">),</span> <span class="n">conditions</span>
    <span class="p">)</span>
    <span class="n">used_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">exp_keys</span><span class="p">)</span>

    <span class="c1"># Combine results and handle unused parameters</span>
    <span class="n">partial_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_conditions</span><span class="p">,</span> <span class="n">beh_conditions</span><span class="p">,</span> <span class="n">stim_conditions</span><span class="p">]</span>
    <span class="n">unused_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_unused_parameters</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">used_keys</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">unused_conditions</span><span class="p">:</span>
        <span class="n">partial_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unused_conditions</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;-----------------------------------------------&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">comb</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">partial_results</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.ExperimentClass.name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.name" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Name of experiment class.</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name of experiment class.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.ExperimentClass.prepare_trial" class="doc doc-heading">
<code class="highlight language-python"><span class="n">prepare_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.prepare_trial" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Prepare trial conditions, stimuli and update trial index.</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">prepare_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare trial conditions, stimuli and update trial index.&quot;&quot;&quot;</span>
    <span class="n">old_cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_get_new_cond</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">thread_end</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">&quot;stimulus_class&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_cond</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="ow">or</span> <span class="n">old_cond</span><span class="p">[</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;stimulus_class&quot;</span> <span class="ow">in</span> <span class="n">old_cond</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;stimulus_class&quot;</span><span class="p">]]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;setting up stimulus&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;stimuli is done&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">update_trial_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">trial_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger_timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="s2">&quot;Trial&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">cond_hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span><span class="p">[</span><span class="s2">&quot;cond_hash&quot;</span><span class="p">],</span> <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_start</span><span class="p">),</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.ExperimentClass.push_conditions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">push_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conditions</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.push_conditions" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Set the experimental conditions and initializes related data structures.</p>
<p>This method takes a list of condition dictionaries, prepares data structures
for tracking choices, blocks, and the current condition.  It also determines
unique choice hashes based on the response condition and difficulty.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>conditions</code></td>
        <td><code>List</code></td>
        <td><p>A list of dictionaries, where each dictionary
represents an experimental condition.  Each condition
dictionary is expected to contain at least a "difficulty"
key.  If a <code>resp_cond</code> key (or the default "response_port")
is present, it's used to create unique choice hashes.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">push_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the experimental conditions and initializes related data structures.</span>

<span class="sd">    This method takes a list of condition dictionaries, prepares data structures</span>
<span class="sd">    for tracking choices, blocks, and the current condition.  It also determines</span>
<span class="sd">    unique choice hashes based on the response condition and difficulty.</span>

<span class="sd">    Args:</span>
<span class="sd">        conditions: A list of dictionaries, where each dictionary</span>
<span class="sd">            represents an experimental condition.  Each condition</span>
<span class="sd">            dictionary is expected to contain at least a &quot;difficulty&quot;</span>
<span class="sd">            key.  If a `resp_cond` key (or the default &quot;response_port&quot;)</span>
<span class="sd">            is present, it&#39;s used to create unique choice hashes.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of conditions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="n">conditions</span>
    <span class="n">resp_cond</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;resp_cond&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;resp_cond&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">else</span> <span class="s2">&quot;response_port&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;difficulty&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">resp_cond</span> <span class="ow">in</span> <span class="n">cond</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">make_hash</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="n">resp_cond</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;difficulty&quot;</span><span class="p">]])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">un_choices</span><span class="p">,</span> <span class="n">un_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">un_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">un_idx</span><span class="p">]</span>
    <span class="c1">#  select random condition for first trial initialization</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
        <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_block</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.ExperimentClass.setup" class="doc doc-heading">
<code class="highlight language-python"><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">behavior_class</span><span class="p">,</span> <span class="n">session_params</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.setup" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Set up Experiment.</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">behavior_class</span><span class="p">,</span> <span class="n">session_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up Experiment.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">quit</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_cond</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">block_h</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stims</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_trial</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cur_block_sz</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span> <span class="o">=</span> <span class="n">session_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">session_params</span><span class="p">[</span><span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_key</span><span class="p">,</span> <span class="s2">&quot;setup_conf_idx&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span><span class="p">}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beh</span> <span class="o">=</span> <span class="n">behavior_class</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interface_setup</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_conf_idx</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">load_calibration</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_session</span><span class="p">(</span>
        <span class="n">session_params</span><span class="p">,</span> <span class="n">experiment_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cond_tables</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">log_task</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">session_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># fix random seed, it can be overidden in the task file</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.ExperimentClass.start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.start" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Start the StateMachine.</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start the StateMachine.&quot;&quot;&quot;</span>
    <span class="n">states</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">():</span>  <span class="c1"># Initialize states</span>
        <span class="n">states</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">state</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="n">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)})</span>
    <span class="n">state_control</span> <span class="o">=</span> <span class="n">StateMachine</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">set_operation_status</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">state_control</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.ExperimentClass.stop" class="doc doc-heading">
<code class="highlight language-python"><span class="n">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.stop" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Stop the epxeriment.</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stop the epxeriment.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">beh</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">is_recording</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for recording to end...&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">closeDatasets</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">in_operation</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.ExperimentClass.validate_condition" class="doc doc-heading">
<code class="highlight language-python"><span class="n">validate_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.ExperimentClass.validate_condition" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Validate a condition dictionary against the required fields.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>condition</code></td>
        <td><code>Dict</code></td>
        <td><p>The condition dictionary to validate.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>ValueError</code></td>
        <td><p>If required fields are missing from the condition.</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate a condition dictionary against the required fields.</span>

<span class="sd">    Args:</span>
<span class="sd">        condition (Dict): The condition dictionary to validate.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If required fields are missing from the condition.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">missing_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_fields</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing_fields</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing experiment required fields: </span><span class="si">{</span><span class="n">missing_fields</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 id="ethopy.core.experiment.MouseWeight" class="doc doc-heading">
        <code>
MouseWeight            (<span title="datajoint.user_tables.Manual">Manual</span>)
        </code>



<a href="#ethopy.core.experiment.MouseWeight" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Table definition:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>animal_id                       : int unsigned                 # id number
timestamp=CURRENT_TIMESTAMP     : timestamp                    # timestamp of weight
---
weight                          : double(5,2)                  # weight in grams
</code></pre></div></td></tr></table></div>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MouseWeight</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    animal_id                       : int unsigned                 # id number</span>
<span class="s2">    timestamp=CURRENT_TIMESTAMP     : timestamp                    # timestamp of weight</span>
<span class="s2">    ---</span>
<span class="s2">    weight                          : double(5,2)                  # weight in grams</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 id="ethopy.core.experiment.Session" class="doc doc-heading">
        <code>
Session            (<span title="datajoint.user_tables.Manual">Manual</span>)
        </code>



<a href="#ethopy.core.experiment.Session" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Table definition:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code># Session info
animal_id                        : smallint UNSIGNED            # animal id
session                          : smallint UNSIGNED            # session number
---
user_name                        : varchar(16)      # user performing the experiment
setup=null                       : varchar(256)     # computer id
experiment_type                  : varchar(128)
session_tmst=CURRENT_TIMESTAMP   : timestamp        # session timestamp
</code></pre></div></td></tr></table></div>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Session</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Session info</span>
<span class="s2">    animal_id                        : smallint UNSIGNED            # animal id</span>
<span class="s2">    session                          : smallint UNSIGNED            # session number</span>
<span class="s2">    ---</span>
<span class="s2">    user_name                        : varchar(16)      # user performing the experiment</span>
<span class="s2">    setup=null                       : varchar(256)     # computer id</span>
<span class="s2">    experiment_type                  : varchar(128)</span>
<span class="s2">    session_tmst=CURRENT_TIMESTAMP   : timestamp        # session timestamp</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        # Task info</span>
<span class="s2">        -&gt; Session</span>
<span class="s2">        ---</span>
<span class="s2">        task_name        : varchar(256)                 # task filename</span>
<span class="s2">        task_file        : blob                         # task text file</span>
<span class="s2">        git_hash             : varchar(32)              # github hash</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Notes</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        # File session info</span>
<span class="s2">        -&gt; Session</span>
<span class="s2">        timestamp=CURRENT_TIMESTAMP : timestamp         # timestamp</span>
<span class="s2">        ---</span>
<span class="s2">        note=null                   : varchar(2048)     # session notes</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Excluded</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        # Excluded sessions</span>
<span class="s2">        -&gt; Session</span>
<span class="s2">        ---</span>
<span class="s2">        reason=null                 : varchar(2048)      # notes for exclusion</span>
<span class="s2">        timestamp=CURRENT_TIMESTAMP : timestamp</span>
<span class="s2">        &quot;&quot;&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-class">



<h3 id="ethopy.core.experiment.Session.Excluded" class="doc doc-heading">
        <code>
Excluded            (<span title="datajoint.user_tables.Part">Part</span>)
        </code>



<a href="#ethopy.core.experiment.Session.Excluded" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Table definition:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code>    # Excluded sessions
    -&gt; Session
    ---
    reason=null                 : varchar(2048)      # notes for exclusion
    timestamp=CURRENT_TIMESTAMP : timestamp
</code></pre></div></td></tr></table></div>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Excluded</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Excluded sessions</span>
<span class="s2">    -&gt; Session</span>
<span class="s2">    ---</span>
<span class="s2">    reason=null                 : varchar(2048)      # notes for exclusion</span>
<span class="s2">    timestamp=CURRENT_TIMESTAMP : timestamp</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="ethopy.core.experiment.Session.Notes" class="doc doc-heading">
        <code>
Notes            (<span title="datajoint.user_tables.Part">Part</span>)
        </code>



<a href="#ethopy.core.experiment.Session.Notes" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Table definition:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code>    # File session info
    -&gt; Session
    timestamp=CURRENT_TIMESTAMP : timestamp         # timestamp
    ---
    note=null                   : varchar(2048)     # session notes
</code></pre></div></td></tr></table></div>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Notes</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # File session info</span>
<span class="s2">    -&gt; Session</span>
<span class="s2">    timestamp=CURRENT_TIMESTAMP : timestamp         # timestamp</span>
<span class="s2">    ---</span>
<span class="s2">    note=null                   : varchar(2048)     # session notes</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="ethopy.core.experiment.Session.Task" class="doc doc-heading">
        <code>
Task            (<span title="datajoint.user_tables.Part">Part</span>)
        </code>



<a href="#ethopy.core.experiment.Session.Task" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Table definition:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code>    # Task info
    -&gt; Session
    ---
    task_name        : varchar(256)                 # task filename
    task_file        : blob                         # task text file
    git_hash             : varchar(32)              # github hash
</code></pre></div></td></tr></table></div>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Lookup</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Experiment parameters</span>
<span class="s2">    task_idx                    : int           # task identification number</span>
<span class="s2">    ---</span>
<span class="s2">    task                        : varchar(4095) # presented stimuli(array of dicts)</span>
<span class="s2">    description=&quot;&quot;              : varchar(2048) # task description</span>
<span class="s2">    timestamp=CURRENT_TIMESTAMP : timestamp</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 id="ethopy.core.experiment.State" class="doc doc-heading">
        <code>
State        </code>



<a href="#ethopy.core.experiment.State" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Base class for implementing experiment states.</p>
<p>This class provides the template for creating states in the experiment state
machine. Each state should inherit from this class and implement the required
methods.</p>

<p><strong>Attributes:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>state_timer</code></td>
        <td><code>Timer</code></td>
        <td><p>Timer instance shared across all states</p></td>
      </tr>
      <tr>
        <td><code>__shared_state</code></td>
        <td></td>
        <td><p>Dictionary containing shared state variables</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for implementing experiment states.</span>

<span class="sd">    This class provides the template for creating states in the experiment state</span>
<span class="sd">    machine. Each state should inherit from this class and implement the required</span>
<span class="sd">    methods.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        state_timer: Timer instance shared across all states</span>
<span class="sd">        __shared_state: Dictionary containing shared state variables</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">state_timer</span><span class="p">:</span> <span class="n">Timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
    <span class="n">__shared_state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ExperimentClass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize state with optional parent experiment.</span>

<span class="sd">        Args:</span>
<span class="sd">            parent: Parent experiment instance this state belongs to</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__shared_state</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">entry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute actions when entering this state.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the main state logic.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the next state to transition to.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Name of the next state to transition to</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If next() is not implemented by child class</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;next not implemented&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute actions when exiting this state.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.State.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#ethopy.core.experiment.State.__init__" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Initialize state with optional parent experiment.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>parent</code></td>
        <td><code>Optional[ExperimentClass]</code></td>
        <td><p>Parent experiment instance this state belongs to</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ExperimentClass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize state with optional parent experiment.</span>

<span class="sd">    Args:</span>
<span class="sd">        parent: Parent experiment instance this state belongs to</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__shared_state</span>
    <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.State.entry" class="doc doc-heading">
<code class="highlight language-python"><span class="n">entry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.State.entry" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Execute actions when entering this state.</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">entry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute actions when entering this state.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.State.exit" class="doc doc-heading">
<code class="highlight language-python"><span class="n">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.State.exit" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Execute actions when exiting this state.</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute actions when exiting this state.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.State.next" class="doc doc-heading">
<code class="highlight language-python"><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.State.next" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Determine the next state to transition to.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>str</code></td>
      <td><p>Name of the next state to transition to</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>AssertionError</code></td>
        <td><p>If next() is not implemented by child class</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine the next state to transition to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Name of the next state to transition to</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If next() is not implemented by child class</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;next not implemented&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.State.run" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.State.run" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Execute the main state logic.</p>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the main state logic.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 id="ethopy.core.experiment.StateMachine" class="doc doc-heading">
        <code>
StateMachine        </code>



<a href="#ethopy.core.experiment.StateMachine" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>State machine implementation for experiment control flow.</p>
<p>Manages transitions between experiment states and ensures proper execution
of state entry/exit hooks. The state machine runs until it reaches the exit
state.</p>

<p><strong>Attributes:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>states</code></td>
        <td><code>Dict[str, State]</code></td>
        <td><p>Mapping of state names to state instances</p></td>
      </tr>
      <tr>
        <td><code>futureState</code></td>
        <td><code>State</code></td>
        <td><p>Next state to transition to</p></td>
      </tr>
      <tr>
        <td><code>currentState</code></td>
        <td><code>State</code></td>
        <td><p>Currently executing state</p></td>
      </tr>
      <tr>
        <td><code>exitState</code></td>
        <td><code>State</code></td>
        <td><p>Final state that ends the state machine</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">StateMachine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;State machine implementation for experiment control flow.</span>

<span class="sd">    Manages transitions between experiment states and ensures proper execution</span>
<span class="sd">    of state entry/exit hooks. The state machine runs until it reaches the exit</span>
<span class="sd">    state.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        states (Dict[str, State]): Mapping of state names to state instances</span>
<span class="sd">        futureState (State): Next state to transition to</span>
<span class="sd">        currentState (State): Currently executing state</span>
<span class="sd">        exitState (State): Final state that ends the state machine</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">State</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the state machine.</span>

<span class="sd">        Args:</span>
<span class="sd">            states: Dictionary mapping state names to state instances</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If required states (Entry, Exit) are missing</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;Entry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">states</span> <span class="ow">or</span> <span class="s2">&quot;Exit&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;StateMachine requires Entry and Exit states&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;Entry&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;Entry&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exitState</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;Exit&quot;</span><span class="p">]</span>

    <span class="c1"># # # # Main state loop # # # # #</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the state machine until reaching exit state.</span>

<span class="sd">        The machine will:</span>
<span class="sd">        1. Check for state transition</span>
<span class="sd">        2. Execute exit hook of current state if transitioning</span>
<span class="sd">        3. Execute entry hook of new state if transitioning</span>
<span class="sd">        4. Execute the current state&#39;s main logic</span>
<span class="sd">        5. Determine next state</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If a state requests transition to non-existent state</span>
<span class="sd">            RuntimeError: If a state&#39;s next() method raises an exception</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitState</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">entry</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

                <span class="n">next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">next_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid state transition to: </span><span class="si">{</span><span class="n">next_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">next_state</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exitState</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;State machine error in state</span>
<span class="s2">                    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.StateMachine.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#ethopy.core.experiment.StateMachine.__init__" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Initialize the state machine.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>states</code></td>
        <td><code>Dict[str, ethopy.core.experiment.State]</code></td>
        <td><p>Dictionary mapping state names to state instances</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>ValueError</code></td>
        <td><p>If required states (Entry, Exit) are missing</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">State</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the state machine.</span>

<span class="sd">    Args:</span>
<span class="sd">        states: Dictionary mapping state names to state instances</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If required states (Entry, Exit) are missing</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;Entry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">states</span> <span class="ow">or</span> <span class="s2">&quot;Exit&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;StateMachine requires Entry and Exit states&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">states</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;Entry&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;Entry&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exitState</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;Exit&quot;</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 id="ethopy.core.experiment.StateMachine.run" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#ethopy.core.experiment.StateMachine.run" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Execute the state machine until reaching exit state.</p>
<p>The machine will:
1. Check for state transition
2. Execute exit hook of current state if transitioning
3. Execute entry hook of new state if transitioning
4. Execute the current state's main logic
5. Determine next state</p>

<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>KeyError</code></td>
        <td><p>If a state requests transition to non-existent state</p></td>
      </tr>
      <tr>
        <td><code>RuntimeError</code></td>
        <td><p>If a state's next() method raises an exception</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the state machine until reaching exit state.</span>

<span class="sd">    The machine will:</span>
<span class="sd">    1. Check for state transition</span>
<span class="sd">    2. Execute exit hook of current state if transitioning</span>
<span class="sd">    3. Execute entry hook of new state if transitioning</span>
<span class="sd">    4. Execute the current state&#39;s main logic</span>
<span class="sd">    5. Determine next state</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If a state requests transition to non-existent state</span>
<span class="sd">        RuntimeError: If a state&#39;s next() method raises an exception</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitState</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">entry</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

            <span class="n">next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">next_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid state transition to: </span><span class="si">{</span><span class="n">next_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">futureState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">next_state</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exitState</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;State machine error in state</span>
<span class="s2">                </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 id="ethopy.core.experiment.Task" class="doc doc-heading">
        <code>
Task            (<span title="datajoint.user_tables.Lookup">Lookup</span>)
        </code>



<a href="#ethopy.core.experiment.Task" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Table definition:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code># Experiment parameters
task_idx                    : int           # task identification number
---
task                        : varchar(4095) # presented stimuli(array of dicts)
description=&quot;&quot;              : varchar(2048) # task description
timestamp=CURRENT_TIMESTAMP : timestamp
</code></pre></div></td></tr></table></div>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Lookup</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Experiment parameters</span>
<span class="s2">    task_idx                    : int           # task identification number</span>
<span class="s2">    ---</span>
<span class="s2">    task                        : varchar(4095) # presented stimuli(array of dicts)</span>
<span class="s2">    description=&quot;&quot;              : varchar(2048) # task description</span>
<span class="s2">    timestamp=CURRENT_TIMESTAMP : timestamp</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 id="ethopy.core.experiment.Trial" class="doc doc-heading">
        <code>
Trial            (<span title="datajoint.user_tables.Manual">Manual</span>)
        </code>



<a href="#ethopy.core.experiment.Trial" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Table definition:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code># Trial information
-&gt; Session
trial_idx            : smallint UNSIGNED       # unique trial index
---
-&gt; Condition
time                 : int                     # start time from session start (ms)
</code></pre></div></td></tr></table></div>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Trial</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Trial information</span>
<span class="s2">    -&gt; Session</span>
<span class="s2">    trial_idx            : smallint UNSIGNED       # unique trial index</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; Condition</span>
<span class="s2">    time                 : int                     # start time from session start (ms)</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Aborted</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        # Aborted Trials</span>
<span class="s2">        -&gt; Trial</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">StateOnset</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        # Trial state timestamps</span>
<span class="s2">        -&gt; Trial</span>
<span class="s2">        time			    : int 	            # time from session start (ms)</span>
<span class="s2">        state               : varchar(64)</span>
<span class="s2">        &quot;&quot;&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-class">



<h3 id="ethopy.core.experiment.Trial.Aborted" class="doc doc-heading">
        <code>
Aborted            (<span title="datajoint.user_tables.Part">Part</span>)
        </code>



<a href="#ethopy.core.experiment.Trial.Aborted" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Table definition:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>    # Aborted Trials
    -&gt; Trial
</code></pre></div></td></tr></table></div>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Aborted</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Aborted Trials</span>
<span class="s2">    -&gt; Trial</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="ethopy.core.experiment.Trial.StateOnset" class="doc doc-heading">
        <code>
StateOnset            (<span title="datajoint.user_tables.Part">Part</span>)
        </code>



<a href="#ethopy.core.experiment.Trial.StateOnset" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Table definition:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>    # Trial state timestamps
    -&gt; Trial
    time                        : int                   # time from session start (ms)
    state               : varchar(64)
</code></pre></div></td></tr></table></div>

        <details class="quote">
          <summary>Source code in <code>ethopy/core/experiment.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">StateOnset</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Trial state timestamps</span>
<span class="s2">    -&gt; Trial</span>
<span class="s2">    time			    : int 	            # time from session start (ms)</span>
<span class="s2">    state               : varchar(64)</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>







  </div>

    </div>

  </div>







  </div>

    </div>

  </div>












                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 - 2024 Alex Evangelou
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.top", "search.highlight", "search.share"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.081f42fc.min.js"></script>
      
    
  </body>
</html>